<!DOCTYPE html>

<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="mobile-web-app-capable" content="yes">
    <title>
        SJU 2020/05/20 - HackMD
    </title>
    <link rel="icon" type="image/png" href="https://hackmd.io/favicon.png">
    <link rel="apple-touch-icon" href="https://hackmd.io/apple-touch-icon.png">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ionicons/2.0.1/css/ionicons.min.css" integrity="sha256-3iu9jgsy9TpTwXKb7bNQzqWekRX7pPK+2OLj3R922fo=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/octicons/3.5.0/octicons.min.css" integrity="sha256-QiWfLIsCT02Sdwkogf6YMiQlj4NE84MKkzEMkZnMGdg=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.5.1/themes/prism.min.css" integrity="sha256-vtR0hSWRc3Tb26iuN2oZHt3KRUomwTufNIf5/4oeCyg=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@hackmd/emojify.js@2.1.0/dist/css/basic/emojify.min.css" integrity="sha256-UOrvMOsSDSrW6szVLe8ZDZezBxh5IoIfgTwdNDgTjiU=" crossorigin="anonymous" />
    <style>
        @charset "UTF-8";@import url(https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,500,500i|Source+Code+Pro:300,400,500|Source+Sans+Pro:300,300i,400,400i,600,600i|Source+Serif+Pro&subset=latin-ext);.hljs{display:block;background:#fff;padding:.5em;color:#333;overflow-x:auto}.hljs-comment,.hljs-meta{color:#969896}.hljs-emphasis,.hljs-quote,.hljs-string,.hljs-strong,.hljs-template-variable,.hljs-variable{color:#df5000}.hljs-keyword,.hljs-selector-tag,.hljs-type{color:#a71d5d}.hljs-attribute,.hljs-bullet,.hljs-literal,.hljs-number,.hljs-symbol{color:#0086b3}.hljs-built_in,.hljs-builtin-name{color:#005cc5}.hljs-name,.hljs-section{color:#63a35c}.hljs-tag{color:#333}.hljs-attr,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-title{color:#795da3}.hljs-addition{color:#55a532;background-color:#eaffea}.hljs-deletion{color:#bd2c00;background-color:#ffecec}.hljs-link{text-decoration:underline}.markdown-body{font-size:16px;line-height:1.5;word-wrap:break-word}.markdown-body:after,.markdown-body:before{display:table;content:""}.markdown-body:after{clear:both}.markdown-body>:first-child{margin-top:0!important}.markdown-body>:last-child{margin-bottom:0!important}.markdown-body a:not([href]){color:inherit;text-decoration:none}.markdown-body .absent{color:#c00}.markdown-body .anchor{float:left;padding-right:4px;margin-left:-20px;line-height:1}.markdown-body .anchor:focus{outline:none}.markdown-body blockquote,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{margin-top:0;margin-bottom:16px}.markdown-body hr{height:.25em;padding:0;margin:24px 0;background-color:#e7e7e7;border:0}.markdown-body blockquote{font-size:16px;padding:0 1em;color:#777;border-left:.25em solid #ddd}.markdown-body blockquote>:first-child{margin-top:0}.markdown-body blockquote>:last-child{margin-bottom:0}.markdown-body kbd,.popover kbd{display:inline-block;padding:3px 5px;font-size:11px;line-height:10px;color:#555;vertical-align:middle;background-color:#fcfcfc;border:1px solid #ccc;border-bottom-color:#bbb;border-radius:3px;box-shadow:inset 0 -1px 0 #bbb}.markdown-body .loweralpha{list-style-type:lower-alpha}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:24px;margin-bottom:16px;font-weight:600;line-height:1.25}.markdown-body h1 .octicon-link,.markdown-body h2 .octicon-link,.markdown-body h3 .octicon-link,.markdown-body h4 .octicon-link,.markdown-body h5 .octicon-link,.markdown-body h6 .octicon-link{color:#000;vertical-align:middle;visibility:hidden}.markdown-body h1:hover .anchor,.markdown-body h2:hover .anchor,.markdown-body h3:hover .anchor,.markdown-body h4:hover .anchor,.markdown-body h5:hover .anchor,.markdown-body h6:hover .anchor{text-decoration:none}.markdown-body h1:hover .anchor .octicon-link,.markdown-body h2:hover .anchor .octicon-link,.markdown-body h3:hover .anchor .octicon-link,.markdown-body h4:hover .anchor .octicon-link,.markdown-body h5:hover .anchor .octicon-link,.markdown-body h6:hover .anchor .octicon-link{visibility:visible}.markdown-body h1 code,.markdown-body h1 tt,.markdown-body h2 code,.markdown-body h2 tt,.markdown-body h3 code,.markdown-body h3 tt,.markdown-body h4 code,.markdown-body h4 tt,.markdown-body h5 code,.markdown-body h5 tt,.markdown-body h6 code,.markdown-body h6 tt{font-size:inherit}.markdown-body h1{font-size:2em}.markdown-body h1,.markdown-body h2{padding-bottom:.3em;border-bottom:1px solid #eee}.markdown-body h2{font-size:1.5em}.markdown-body h3{font-size:1.25em}.markdown-body h4{font-size:1em}.markdown-body h5{font-size:.875em}.markdown-body h6{font-size:.85em;color:#777}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol.no-list,.markdown-body ul.no-list{padding:0;list-style-type:none}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:0;margin-bottom:0}.markdown-body li>p{margin-top:16px}.markdown-body li+li{padding-top:.25em}.markdown-body dl{padding:0}.markdown-body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:700}.markdown-body dl dd{padding:0 16px;margin-bottom:16px}.markdown-body table{display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}.markdown-body table th{font-weight:700}.markdown-body table td,.markdown-body table th{padding:6px 13px;border:1px solid #ddd}.markdown-body table tr{background-color:#fff;border-top:1px solid #ccc}.markdown-body table tr:nth-child(2n){background-color:#f8f8f8}.markdown-body img{max-width:100%;box-sizing:content-box;background-color:#fff}.markdown-body img[align=right]{padding-left:20px}.markdown-body img[align=left]{padding-right:20px}.markdown-body .emoji{max-width:none;vertical-align:text-top;background-color:transparent}.markdown-body span.frame{display:block;overflow:hidden}.markdown-body span.frame>span{display:block;float:left;width:auto;padding:7px;margin:13px 0 0;overflow:hidden;border:1px solid #ddd}.markdown-body span.frame span img{display:block;float:left}.markdown-body span.frame span span{display:block;padding:5px 0 0;clear:both;color:#333}.markdown-body span.align-center{display:block;overflow:hidden;clear:both}.markdown-body span.align-center>span{display:block;margin:13px auto 0;overflow:hidden;text-align:center}.markdown-body span.align-center span img{margin:0 auto;text-align:center}.markdown-body span.align-right{display:block;overflow:hidden;clear:both}.markdown-body span.align-right>span{display:block;margin:13px 0 0;overflow:hidden;text-align:right}.markdown-body span.align-right span img{margin:0;text-align:right}.markdown-body span.float-left{display:block;float:left;margin-right:13px;overflow:hidden}.markdown-body span.float-left span{margin:13px 0 0}.markdown-body span.float-right{display:block;float:right;margin-left:13px;overflow:hidden}.markdown-body span.float-right>span{display:block;margin:13px auto 0;overflow:hidden;text-align:right}.markdown-body code,.markdown-body tt{padding:0;padding-top:.2em;padding-bottom:.2em;margin:0;font-size:85%;background-color:rgba(0,0,0,.04);border-radius:3px}.markdown-body code:after,.markdown-body code:before,.markdown-body tt:after,.markdown-body tt:before{letter-spacing:-.2em;content:"\00a0"}.markdown-body code br,.markdown-body tt br{display:none}.markdown-body del code{text-decoration:inherit}.markdown-body pre{word-wrap:normal}.markdown-body pre>code{padding:0;margin:0;font-size:100%;word-break:normal;white-space:pre;background:transparent;border:0}.markdown-body .highlight{margin-bottom:16px}.markdown-body .highlight pre{margin-bottom:0;word-break:normal}.markdown-body .highlight pre,.markdown-body pre{padding:16px;overflow:auto;font-size:85%;line-height:1.45;background-color:#f7f7f7;border-radius:3px}.markdown-body pre code,.markdown-body pre tt{display:inline;max-width:auto;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}.markdown-body pre code:after,.markdown-body pre code:before,.markdown-body pre tt:after,.markdown-body pre tt:before{content:normal}.markdown-body .csv-data td,.markdown-body .csv-data th{padding:5px;overflow:hidden;font-size:12px;line-height:1;text-align:left;white-space:nowrap}.markdown-body .csv-data .blob-line-num{padding:10px 8px 9px;text-align:right;background:#fff;border:0}.markdown-body .csv-data tr{border-top:0}.markdown-body .csv-data th{font-weight:700;background:#f8f8f8;border-top:0}.news .alert .markdown-body blockquote{padding:0 0 0 40px;border:0 none}.activity-tab .news .alert .commits,.activity-tab .news .markdown-body blockquote{padding-left:0}.task-list-item{list-style-type:none}.task-list-item label{font-weight:400}.task-list-item.enabled label{cursor:pointer}.task-list-item+.task-list-item{margin-top:3px}.task-list-item-checkbox{float:left;margin:.31em 0 .2em -1.3em!important;vertical-align:middle;cursor:default!important}.markdown-body{padding-top:40px;padding-bottom:40px;max-width:758px;overflow:visible!important;position:relative}.markdown-body .emoji{vertical-align:top}.markdown-body pre{border:inherit!important}.markdown-body code{color:inherit!important}.markdown-body pre code .wrapper{display:-moz-inline-flex;display:-ms-inline-flex;display:-o-inline-flex;display:inline-flex}.markdown-body pre code .gutter{float:left;overflow:hidden;-webkit-user-select:none;user-select:none}.markdown-body pre code .gutter.linenumber{text-align:right;position:relative;display:inline-block;cursor:default;z-index:4;padding:0 8px 0 0;min-width:20px;box-sizing:content-box;color:#afafaf!important;border-right:3px solid #6ce26c!important}.markdown-body pre code .gutter.linenumber>span:before{content:attr(data-linenumber)}.markdown-body pre code .code{float:left;margin:0 0 0 16px}.markdown-body .gist .line-numbers{border-left:none;border-top:none;border-bottom:none}.markdown-body .gist .line-data{border:none}.markdown-body .gist table{border-spacing:0;border-collapse:inherit!important}.markdown-body code[data-gist-id]{background:none;padding:0}.markdown-body code[data-gist-id]:after,.markdown-body code[data-gist-id]:before{content:""}.markdown-body code[data-gist-id] .blob-num{border:unset}.markdown-body code[data-gist-id] table{overflow:unset;margin-bottom:unset}.markdown-body code[data-gist-id] table tr{background:unset}.markdown-body[dir=rtl] pre{direction:ltr}.markdown-body[dir=rtl] code{direction:ltr;unicode-bidi:embed}.markdown-body .alert>p{margin-bottom:0}.markdown-body pre.abc,.markdown-body pre.flow-chart,.markdown-body pre.graphviz,.markdown-body pre.mermaid,.markdown-body pre.sequence-diagram,.markdown-body pre.vega{text-align:center;background-color:inherit;border-radius:0;white-space:inherit;overflow:visible}.markdown-body pre.abc>code,.markdown-body pre.flow-chart>code,.markdown-body pre.graphviz>code,.markdown-body pre.mermaid>code,.markdown-body pre.sequence-diagram>code,.markdown-body pre.vega>code{text-align:left}.markdown-body pre.abc>svg,.markdown-body pre.flow-chart>svg,.markdown-body pre.graphviz>svg,.markdown-body pre.mermaid>svg,.markdown-body pre.sequence-diagram>svg,.markdown-body pre.vega>svg{max-width:100%;height:100%}.markdown-body pre>code.wrap{white-space:pre-wrap;white-space:-moz-pre-wrap;white-space:-pre-wrap;white-space:-o-pre-wrap;word-wrap:break-word}.markdown-body .alert>p,.markdown-body .alert>ul{margin-bottom:0}.markdown-body summary{display:list-item}.markdown-body summary:focus{outline:none}.markdown-body details summary{cursor:pointer}.markdown-body details:not([open])>:not(summary){display:none}.markdown-body figure{margin:1em 40px}.markdown-body .mark,.markdown-body mark{background-color:#fff1a7}.vimeo,.youtube{cursor:pointer;display:table;text-align:center;background-position:50%;background-repeat:no-repeat;background-size:contain;background-color:#000;overflow:hidden}.vimeo,.youtube{position:relative;width:100%}.youtube{padding-bottom:56.25%}.vimeo img{width:100%;object-fit:contain;z-index:0}.youtube img{object-fit:cover;z-index:0}.vimeo iframe,.youtube iframe,.youtube img{width:100%;height:100%;position:absolute;top:0;left:0}.vimeo iframe,.youtube iframe{vertical-align:middle;z-index:1}.vimeo .icon,.youtube .icon{position:absolute;height:auto;width:auto;top:50%;left:50%;transform:translate(-50%,-50%);color:#fff;opacity:.3;transition:opacity .2s;z-index:0}.vimeo:hover .icon,.youtube:hover .icon{opacity:.6;transition:opacity .2s}.slideshare .inner,.speakerdeck .inner{position:relative;width:100%}.slideshare .inner iframe,.speakerdeck .inner iframe{position:absolute;top:0;bottom:0;left:0;right:0;width:100%;height:100%}.MJX_Assistive_MathML{display:none}#MathJax_Message{z-index:1000!important}.ui-infobar{position:relative;z-index:2;max-width:760px;margin:25px auto -25px;color:#777}.toc .invisable-node{list-style-type:none}.ui-toc{position:fixed;bottom:20px;z-index:998}.ui-toc.both-mode{margin-left:8px}.ui-toc.both-mode .ui-toc-label{height:40px;padding:10px 4px;border-top-left-radius:0;border-bottom-left-radius:0}.ui-toc-label{background-color:#e6e6e6;border:none;color:#868686;transition:opacity .2s}.ui-toc .open .ui-toc-label{opacity:1;color:#fff;transition:opacity .2s}.ui-toc-label:focus{opacity:.3;background-color:#ccc;color:#000}.ui-toc-label:hover{opacity:1;background-color:#ccc;transition:opacity .2s}.ui-toc-dropdown{margin-top:20px;margin-bottom:20px;padding-left:10px;padding-right:10px;max-width:45vw;width:25vw;max-height:70vh;overflow:auto;text-align:inherit}.ui-toc-dropdown>.toc{max-height:calc(70vh - 100px);overflow:auto}.ui-toc-dropdown[dir=rtl] .nav{padding-right:0;letter-spacing:.0029em}.ui-toc-dropdown a{overflow:hidden;text-overflow:ellipsis;white-space:pre}.ui-toc-dropdown .nav>li>a{display:block;padding:4px 20px;font-size:13px;font-weight:500;color:#767676}.ui-toc-dropdown .nav>li:first-child:last-child > ul,.ui-toc-dropdown .toc.expand ul{display:block}.ui-toc-dropdown .nav>li>a:focus,.ui-toc-dropdown .nav>li>a:hover{padding-left:19px;color:#000;text-decoration:none;background-color:transparent;border-left:1px solid #000}.ui-toc-dropdown[dir=rtl] .nav>li>a:focus,.ui-toc-dropdown[dir=rtl] .nav>li>a:hover{padding-right:19px;border-left:none;border-right:1px solid #000}.ui-toc-dropdown .nav>.active:focus>a,.ui-toc-dropdown .nav>.active:hover>a,.ui-toc-dropdown .nav>.active>a{padding-left:18px;font-weight:700;color:#000;background-color:transparent;border-left:2px solid #000}.ui-toc-dropdown[dir=rtl] .nav>.active:focus>a,.ui-toc-dropdown[dir=rtl] .nav>.active:hover>a,.ui-toc-dropdown[dir=rtl] .nav>.active>a{padding-right:18px;border-left:none;border-right:2px solid #000}.ui-toc-dropdown .nav .nav{display:none;padding-bottom:10px}.ui-toc-dropdown .nav>.active>ul{display:block}.ui-toc-dropdown .nav .nav>li>a{padding-top:1px;padding-bottom:1px;padding-left:30px;font-size:12px;font-weight:400}.ui-toc-dropdown[dir=rtl] .nav .nav>li>a{padding-right:30px}.ui-toc-dropdown .nav .nav>li>ul>li>a{padding-top:1px;padding-bottom:1px;padding-left:40px;font-size:12px;font-weight:400}.ui-toc-dropdown[dir=rtl] .nav .nav>li>ul>li>a{padding-right:40px}.ui-toc-dropdown .nav .nav>li>a:focus,.ui-toc-dropdown .nav .nav>li>a:hover{padding-left:29px}.ui-toc-dropdown[dir=rtl] .nav .nav>li>a:focus,.ui-toc-dropdown[dir=rtl] .nav .nav>li>a:hover{padding-right:29px}.ui-toc-dropdown .nav .nav>li>ul>li>a:focus,.ui-toc-dropdown .nav .nav>li>ul>li>a:hover{padding-left:39px}.ui-toc-dropdown[dir=rtl] .nav .nav>li>ul>li>a:focus,.ui-toc-dropdown[dir=rtl] .nav .nav>li>ul>li>a:hover{padding-right:39px}.ui-toc-dropdown .nav .nav>.active:focus>a,.ui-toc-dropdown .nav .nav>.active:hover>a,.ui-toc-dropdown .nav .nav>.active>a{padding-left:28px;font-weight:500}.ui-toc-dropdown[dir=rtl] .nav .nav>.active:focus>a,.ui-toc-dropdown[dir=rtl] .nav .nav>.active:hover>a,.ui-toc-dropdown[dir=rtl] .nav .nav>.active>a{padding-right:28px}.ui-toc-dropdown .nav .nav>.active>.nav>.active:focus>a,.ui-toc-dropdown .nav .nav>.active>.nav>.active:hover>a,.ui-toc-dropdown .nav .nav>.active>.nav>.active>a{padding-left:38px;font-weight:500}.ui-toc-dropdown[dir=rtl] .nav .nav>.active>.nav>.active:focus>a,.ui-toc-dropdown[dir=rtl] .nav .nav>.active>.nav>.active:hover>a,.ui-toc-dropdown[dir=rtl] .nav .nav>.active>.nav>.active>a{padding-right:38px}.markdown-body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica Neue,Helvetica,Roboto,Arial,sans-serif}html[lang^=ja] .markdown-body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica Neue,Helvetica,Roboto,Arial,Hiragino Kaku Gothic Pro,ヒラギノ角ゴ Pro W3,Osaka,Meiryo,メイリオ,MS Gothic,ＭＳ\ ゴシック,sans-serif}html[lang=zh-tw] .markdown-body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica Neue,Helvetica,Roboto,Arial,PingFang TC,Microsoft JhengHei,微軟正黑,sans-serif}html[lang=zh-cn] .markdown-body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica Neue,Helvetica,Roboto,Arial,PingFang SC,Microsoft YaHei,微软雅黑,sans-serif}html .markdown-body[lang^=ja]{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica Neue,Helvetica,Roboto,Arial,Hiragino Kaku Gothic Pro,ヒラギノ角ゴ Pro W3,Osaka,Meiryo,メイリオ,MS Gothic,ＭＳ\ ゴシック,sans-serif}html .markdown-body[lang=zh-tw]{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica Neue,Helvetica,Roboto,Arial,PingFang TC,Microsoft JhengHei,微軟正黑,sans-serif}html .markdown-body[lang=zh-cn]{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica Neue,Helvetica,Roboto,Arial,PingFang SC,Microsoft YaHei,微软雅黑,sans-serif}html[lang^=ja] .ui-toc-dropdown{font-family:Source Sans Pro,Helvetica,Arial,Meiryo UI,MS PGothic,ＭＳ\ Ｐゴシック,sans-serif}html[lang=zh-tw] .ui-toc-dropdown{font-family:Source Sans Pro,Helvetica,Arial,Microsoft JhengHei UI,微軟正黑UI,sans-serif}html[lang=zh-cn] .ui-toc-dropdown{font-family:Source Sans Pro,Helvetica,Arial,Microsoft YaHei UI,微软雅黑UI,sans-serif}html .ui-toc-dropdown[lang^=ja]{font-family:Source Sans Pro,Helvetica,Arial,Meiryo UI,MS PGothic,ＭＳ\ Ｐゴシック,sans-serif}html .ui-toc-dropdown[lang=zh-tw]{font-family:Source Sans Pro,Helvetica,Arial,Microsoft JhengHei UI,微軟正黑UI,sans-serif}html .ui-toc-dropdown[lang=zh-cn]{font-family:Source Sans Pro,Helvetica,Arial,Microsoft YaHei UI,微软雅黑UI,sans-serif}.ui-affix-toc{position:fixed;top:0;max-width:15vw;max-height:70vh;overflow:auto}.back-to-top,.expand-toggle,.go-to-bottom{display:block;padding:4px 10px;margin-top:10px;margin-left:10px;font-size:12px;font-weight:500;color:#999}.back-to-top:focus,.back-to-top:hover,.expand-toggle:focus,.expand-toggle:hover,.go-to-bottom:focus,.go-to-bottom:hover{color:#563d7c;text-decoration:none}.back-to-top,.go-to-bottom{margin-top:0}.ui-user-icon{width:20px;height:20px;display:block;border-radius:3px;margin-top:2px;margin-bottom:2px;margin-right:5px;background-position:50%;background-repeat:no-repeat;background-size:cover}.ui-user-icon.small{width:18px;height:18px;display:inline-block;vertical-align:middle;margin:0 0 .2em}.ui-infobar>small>span{line-height:22px}.ui-infobar>small .dropdown{display:inline-block}.ui-infobar>small .dropdown a:focus,.ui-infobar>small .dropdown a:hover{text-decoration:none}.ui-published-note{color:#337ab7}.ui-published-note .fa{font-size:20px;vertical-align:top}.unselectable{-webkit-user-select:none;-o-user-select:none;user-select:none}.selectable{-webkit-user-select:text;-o-user-select:text;user-select:text}@media print{blockquote,div,img,pre,table{page-break-inside:avoid!important}a[href]:after{font-size:12px!important}}.markdown-body.slides{position:relative;z-index:1;color:#222}.markdown-body.slides:before{content:"";display:block;position:absolute;top:0;left:0;right:0;bottom:0;z-index:-1;background-color:currentColor;box-shadow:0 0 0 50vw}.markdown-body.slides section[data-markdown]{position:relative;margin-bottom:1.5em;background-color:#fff;text-align:center}.markdown-body.slides section[data-markdown] code{text-align:left}.markdown-body.slides section[data-markdown]:before{content:"";display:block;padding-bottom:56.23%}.markdown-body.slides section[data-markdown]>div:first-child{position:absolute;top:50%;left:1em;right:1em;transform:translateY(-50%);max-height:100%;overflow:hidden}.markdown-body.slides section[data-markdown]>ul{display:inline-block}.markdown-body.slides>section>section+section:after{content:"";position:absolute;top:-1.5em;right:1em;height:1.5em;border:3px solid #777}.site-ui-font{font-family:Source Sans Pro,Helvetica,Arial,sans-serif}html[lang^=ja] .site-ui-font{font-family:Source Sans Pro,Helvetica,Arial,Hiragino Kaku Gothic Pro,ヒラギノ角ゴ Pro W3,Osaka,Meiryo,メイリオ,MS Gothic,ＭＳ\ ゴシック,sans-serif}html[lang=zh-tw] .site-ui-font{font-family:Source Sans Pro,Helvetica,Arial,PingFang TC,Microsoft JhengHei,微軟正黑,sans-serif}html[lang=zh-cn] .site-ui-font{font-family:Source Sans Pro,Helvetica,Arial,PingFang SC,Microsoft YaHei,微软雅黑,sans-serif}body{font-smoothing:subpixel-antialiased!important;-webkit-font-smoothing:subpixel-antialiased!important;-moz-osx-font-smoothing:auto!important;text-shadow:0 0 1em transparent,1px 1px 1.2px rgba(0,0,0,.004);-webkit-overflow-scrolling:touch;letter-spacing:.025em;font-family:Source Sans Pro,Helvetica,Arial,sans-serif}html[lang^=ja] body{font-family:Source Sans Pro,Helvetica,Arial,Hiragino Kaku Gothic Pro,ヒラギノ角ゴ Pro W3,Osaka,Meiryo,メイリオ,MS Gothic,ＭＳ\ ゴシック,sans-serif}html[lang=zh-tw] body{font-family:Source Sans Pro,Helvetica,Arial,PingFang TC,Microsoft JhengHei,微軟正黑,sans-serif}html[lang=zh-cn] body{font-family:Source Sans Pro,Helvetica,Arial,PingFang SC,Microsoft YaHei,微软雅黑,sans-serif}abbr[title]{border-bottom:none;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}abbr[data-original-title],abbr[title]{cursor:help}body.modal-open{overflow-y:auto;padding-right:0!important}
    </style>
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    	<script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.min.js" integrity="sha256-3Jy/GbSLrg0o9y5Z5n1uw0qxZECH7C6OQpVBgNFYa0g=" crossorigin="anonymous"></script>
    	<script src="https://cdnjs.cloudflare.com/ajax/libs/respond.js/1.4.2/respond.min.js" integrity="sha256-g6iAfvZp+nDQ2TdTR/VVKJf3bGro4ub5fvWSWVRi2NE=" crossorigin="anonymous"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/es5-shim/4.5.9/es5-shim.min.js" integrity="sha256-8E4Is26QH0bD52WoQpcB+R/tcWQtpzlCojrybUd7Mxo=" crossorigin="anonymous"></script>
    <![endif]-->
</head>

<body>
    <div id="doc" class="markdown-body container-fluid comment-enabled" data-hard-breaks="true"><h1 id="SJU-20200520" data-id="SJU-20200520"><a class="anchor hidden-xs" href="#SJU-20200520" title="SJU-20200520"><span class="octicon octicon-link"></span></a><span>SJU 2020/05/20</span></h1><h2 id="Zadanie-1" data-id="Zadanie-1"><a class="anchor hidden-xs" href="#Zadanie-1" title="Zadanie-1"><span class="octicon octicon-link"></span></a><span>Zadanie 1.</span></h2><ul>
<li><span>średnie obciążenie </span><em><span>(ang. load average)</span></em><span> – średnie obciążenie systemu</span></li>
<li><span>wykładnicze uśrednianie </span><em><span>(ang. exponential averaging)</span></em><span> – czas potrzebny na wykonanie </span><span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span id="MathJax-Element-33-Frame" class="mjx-chtml MathJax_CHTML" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>n</mi></math>" role="presentation" style="font-size: 119%; position: relative;"><span id="MJXc-Node-268" class="mjx-math" aria-hidden="true"><span id="MJXc-Node-269" class="mjx-mrow"><span id="MJXc-Node-270" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.213em; padding-bottom: 0.265em;">n</span></span></span></span><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>n</mi></math></span></span><script type="math/tex" id="MathJax-Element-33">n</script></span><span>–tej instancji procesu może być przewidziany jako </span><span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span id="MathJax-Element-34-Frame" class="mjx-chtml MathJax_CHTML" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>S</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>n</mi><mo>+</mo><mn>1</mn></mrow></msub><mo>=</mo><mi>&amp;#x03B1;</mi><msub><mi>T</mi><mi>n</mi></msub><mo>+</mo><mo stretchy=&quot;false&quot;>(</mo><mn>1</mn><mo>&amp;#x2212;</mo><mi>&amp;#x03B1;</mi><mo stretchy=&quot;false&quot;>)</mo><msub><mi>S</mi><mi>n</mi></msub></math>" role="presentation" style="font-size: 119%; position: relative;"><span id="MJXc-Node-271" class="mjx-math" aria-hidden="true"><span id="MJXc-Node-272" class="mjx-mrow"><span id="MJXc-Node-273" class="mjx-msubsup"><span class="mjx-base" style="margin-right: -0.032em;"><span id="MJXc-Node-274" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.475em; padding-bottom: 0.318em; padding-right: 0.032em;">S</span></span></span><span class="mjx-sub" style="font-size: 70.7%; vertical-align: -0.212em; padding-right: 0.071em;"><span id="MJXc-Node-275" class="mjx-texatom" style=""><span id="MJXc-Node-276" class="mjx-mrow"><span id="MJXc-Node-277" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.213em; padding-bottom: 0.265em;">n</span></span><span id="MJXc-Node-278" class="mjx-mo"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.318em; padding-bottom: 0.423em;">+</span></span><span id="MJXc-Node-279" class="mjx-mn"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.37em; padding-bottom: 0.318em;">1</span></span></span></span></span></span><span id="MJXc-Node-280" class="mjx-mo MJXc-space3"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.055em; padding-bottom: 0.318em;">=</span></span><span id="MJXc-Node-281" class="mjx-mi MJXc-space3"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.213em; padding-bottom: 0.265em;">α</span></span><span id="MJXc-Node-282" class="mjx-msubsup"><span class="mjx-base" style="margin-right: -0.12em;"><span id="MJXc-Node-283" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.475em; padding-bottom: 0.265em; padding-right: 0.12em;">T</span></span></span><span class="mjx-sub" style="font-size: 70.7%; vertical-align: -0.212em; padding-right: 0.071em;"><span id="MJXc-Node-284" class="mjx-mi" style=""><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.213em; padding-bottom: 0.265em;">n</span></span></span></span><span id="MJXc-Node-285" class="mjx-mo MJXc-space2"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.318em; padding-bottom: 0.423em;">+</span></span><span id="MJXc-Node-286" class="mjx-mo MJXc-space2"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.475em; padding-bottom: 0.58em;">(</span></span><span id="MJXc-Node-287" class="mjx-mn"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.37em; padding-bottom: 0.318em;">1</span></span><span id="MJXc-Node-288" class="mjx-mo MJXc-space2"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.318em; padding-bottom: 0.423em;">−</span></span><span id="MJXc-Node-289" class="mjx-mi MJXc-space2"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.213em; padding-bottom: 0.265em;">α</span></span><span id="MJXc-Node-290" class="mjx-mo"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.475em; padding-bottom: 0.58em;">)</span></span><span id="MJXc-Node-291" class="mjx-msubsup"><span class="mjx-base" style="margin-right: -0.032em;"><span id="MJXc-Node-292" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.475em; padding-bottom: 0.318em; padding-right: 0.032em;">S</span></span></span><span class="mjx-sub" style="font-size: 70.7%; vertical-align: -0.212em; padding-right: 0.071em;"><span id="MJXc-Node-293" class="mjx-mi" style=""><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.213em; padding-bottom: 0.265em;">n</span></span></span></span></span></span><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>S</mi><mrow class="MJX-TeXAtom-ORD"><mi>n</mi><mo>+</mo><mn>1</mn></mrow></msub><mo>=</mo><mi>α</mi><msub><mi>T</mi><mi>n</mi></msub><mo>+</mo><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mi>α</mi><mo stretchy="false">)</mo><msub><mi>S</mi><mi>n</mi></msub></math></span></span><script type="math/tex" id="MathJax-Element-34">S_{n + 1} = \alpha T_n + (1 - \alpha)S_n</script></span><span>, gdzie </span><span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span id="MathJax-Element-35-Frame" class="mjx-chtml MathJax_CHTML" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mn>0</mn><mo>&amp;lt;</mo><mi>&amp;#x03B1;</mi><mo>&amp;lt;</mo><mn>1</mn></math>" role="presentation" style="font-size: 119%; position: relative;"><span id="MJXc-Node-294" class="mjx-math" aria-hidden="true"><span id="MJXc-Node-295" class="mjx-mrow"><span id="MJXc-Node-296" class="mjx-mn"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.37em; padding-bottom: 0.37em;">0</span></span><span id="MJXc-Node-297" class="mjx-mo MJXc-space3"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.265em; padding-bottom: 0.37em;">&lt;</span></span><span id="MJXc-Node-298" class="mjx-mi MJXc-space3"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.213em; padding-bottom: 0.265em;">α</span></span><span id="MJXc-Node-299" class="mjx-mo MJXc-space3"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.265em; padding-bottom: 0.37em;">&lt;</span></span><span id="MJXc-Node-300" class="mjx-mn MJXc-space3"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.37em; padding-bottom: 0.318em;">1</span></span></span></span><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mn>0</mn><mo>&lt;</mo><mi>α</mi><mo>&lt;</mo><mn>1</mn></math></span></span><script type="math/tex" id="MathJax-Element-35">0 < \alpha < 1</script></span><span>. Gdzie </span><span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span id="MathJax-Element-36-Frame" class="mjx-chtml MathJax_CHTML" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>S</mi><mi>n</mi></msub></math>" role="presentation" style="font-size: 119%; position: relative;"><span id="MJXc-Node-301" class="mjx-math" aria-hidden="true"><span id="MJXc-Node-302" class="mjx-mrow"><span id="MJXc-Node-303" class="mjx-msubsup"><span class="mjx-base" style="margin-right: -0.032em;"><span id="MJXc-Node-304" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.475em; padding-bottom: 0.318em; padding-right: 0.032em;">S</span></span></span><span class="mjx-sub" style="font-size: 70.7%; vertical-align: -0.212em; padding-right: 0.071em;"><span id="MJXc-Node-305" class="mjx-mi" style=""><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.213em; padding-bottom: 0.265em;">n</span></span></span></span></span></span><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>S</mi><mi>n</mi></msub></math></span></span><script type="math/tex" id="MathJax-Element-36">S_n</script></span><span> to jest średnie obciążenie, a </span><span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span id="MathJax-Element-37-Frame" class="mjx-chtml MathJax_CHTML" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>T</mi><mi>n</mi></msub></math>" role="presentation" style="font-size: 119%; position: relative;"><span id="MJXc-Node-306" class="mjx-math" aria-hidden="true"><span id="MJXc-Node-307" class="mjx-mrow"><span id="MJXc-Node-308" class="mjx-msubsup"><span class="mjx-base" style="margin-right: -0.12em;"><span id="MJXc-Node-309" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.475em; padding-bottom: 0.265em; padding-right: 0.12em;">T</span></span></span><span class="mjx-sub" style="font-size: 70.7%; vertical-align: -0.212em; padding-right: 0.071em;"><span id="MJXc-Node-310" class="mjx-mi" style=""><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.213em; padding-bottom: 0.265em;">n</span></span></span></span></span></span><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>T</mi><mi>n</mi></msub></math></span></span><script type="math/tex" id="MathJax-Element-37">T_n</script></span><span> to obciążenie przy </span><span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span id="MathJax-Element-38-Frame" class="mjx-chtml MathJax_CHTML" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>n</mi></math>" role="presentation" style="font-size: 119%; position: relative;"><span id="MJXc-Node-311" class="mjx-math" aria-hidden="true"><span id="MJXc-Node-312" class="mjx-mrow"><span id="MJXc-Node-313" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.213em; padding-bottom: 0.265em;">n</span></span></span></span><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>n</mi></math></span></span><script type="math/tex" id="MathJax-Element-38">n</script></span><span>–tym wywołaniu instacji procesu.</span></li>
<li><span>shortest process next (SPN) – polityka schedulera. Polityka bez wywłaszczania, w której wybierany jest proces z najkrótszym oczekiwanym czasem działania jako następny. Problemem w tej polityce jest, że musimy określić czas działania procesu (a przynajmniej jakieś przybliżenie) co wydaje się trudnym problemem. Ale z pomocą przychodzą magiczne wzorki mądrych ludzi </span><span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span id="MathJax-Element-39-Frame" class="mjx-chtml MathJax_CHTML" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>S</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>n</mi><mo>+</mo><mn>1</mn></mrow></msub><mo>=</mo><mfrac><mn>1</mn><mi>n</mi></mfrac><munderover><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>n</mi></mrow></munderover><msub><mi>T</mi><mi>i</mi></msub></math>" role="presentation" style="font-size: 119%; position: relative;"><span id="MJXc-Node-314" class="mjx-math" aria-hidden="true"><span id="MJXc-Node-315" class="mjx-mrow"><span id="MJXc-Node-316" class="mjx-msubsup"><span class="mjx-base" style="margin-right: -0.032em;"><span id="MJXc-Node-317" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.475em; padding-bottom: 0.318em; padding-right: 0.032em;">S</span></span></span><span class="mjx-sub" style="font-size: 70.7%; vertical-align: -0.212em; padding-right: 0.071em;"><span id="MJXc-Node-318" class="mjx-texatom" style=""><span id="MJXc-Node-319" class="mjx-mrow"><span id="MJXc-Node-320" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.213em; padding-bottom: 0.265em;">n</span></span><span id="MJXc-Node-321" class="mjx-mo"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.318em; padding-bottom: 0.423em;">+</span></span><span id="MJXc-Node-322" class="mjx-mn"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.37em; padding-bottom: 0.318em;">1</span></span></span></span></span></span><span id="MJXc-Node-323" class="mjx-mo MJXc-space3"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.055em; padding-bottom: 0.318em;">=</span></span><span id="MJXc-Node-324" class="mjx-mfrac MJXc-space3"><span class="mjx-box MJXc-stacked" style="width: 0.566em; padding: 0px 0.12em;"><span class="mjx-numerator" style="font-size: 70.7%; width: 0.8em; top: -1.298em;"><span id="MJXc-Node-325" class="mjx-mn" style=""><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.37em; padding-bottom: 0.318em;">1</span></span></span><span class="mjx-denominator" style="font-size: 70.7%; width: 0.8em; bottom: -0.524em;"><span id="MJXc-Node-326" class="mjx-mi" style=""><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.213em; padding-bottom: 0.265em;">n</span></span></span><span class="mjx-line" style="border-bottom: 1.3px solid; top: -0.283em; width: 0.566em;"></span></span><span class="mjx-vsize" style="height: 1.288em; vertical-align: -0.37em;"></span></span><span id="MJXc-Node-327" class="mjx-munderover MJXc-space1"><span class="mjx-base"><span id="MJXc-Node-328" class="mjx-mo"><span class="mjx-char MJXc-TeX-size1-R" style="padding-top: 0.528em; padding-bottom: 0.528em;">∑</span></span></span><span class="mjx-stack" style="vertical-align: -0.31em;"><span class="mjx-sup" style="font-size: 70.7%; padding-bottom: 0.422em; padding-left: 0px; padding-right: 0.071em;"><span id="MJXc-Node-334" class="mjx-texatom" style=""><span id="MJXc-Node-335" class="mjx-mrow"><span id="MJXc-Node-336" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.213em; padding-bottom: 0.265em;">n</span></span></span></span></span><span class="mjx-sub" style="font-size: 70.7%; padding-right: 0.071em;"><span id="MJXc-Node-329" class="mjx-texatom" style=""><span id="MJXc-Node-330" class="mjx-mrow"><span id="MJXc-Node-331" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.423em; padding-bottom: 0.265em;">i</span></span><span id="MJXc-Node-332" class="mjx-mo"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.055em; padding-bottom: 0.318em;">=</span></span><span id="MJXc-Node-333" class="mjx-mn"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.37em; padding-bottom: 0.318em;">1</span></span></span></span></span></span></span><span id="MJXc-Node-337" class="mjx-msubsup MJXc-space1"><span class="mjx-base" style="margin-right: -0.12em;"><span id="MJXc-Node-338" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.475em; padding-bottom: 0.265em; padding-right: 0.12em;">T</span></span></span><span class="mjx-sub" style="font-size: 70.7%; vertical-align: -0.212em; padding-right: 0.071em;"><span id="MJXc-Node-339" class="mjx-mi" style=""><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.423em; padding-bottom: 0.265em;">i</span></span></span></span></span></span><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>S</mi><mrow class="MJX-TeXAtom-ORD"><mi>n</mi><mo>+</mo><mn>1</mn></mrow></msub><mo>=</mo><mfrac><mn>1</mn><mi>n</mi></mfrac><munderover><mo>∑</mo><mrow class="MJX-TeXAtom-ORD"><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mrow class="MJX-TeXAtom-ORD"><mi>n</mi></mrow></munderover><msub><mi>T</mi><mi>i</mi></msub></math></span></span><script type="math/tex" id="MathJax-Element-39">S_{n + 1} = \frac{1}{n} \sum_{i = 1}^{n} T_i</script></span><span>.</span><br>
<span>a więc </span><span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span id="MathJax-Element-40-Frame" class="mjx-chtml MathJax_CHTML" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>S</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>n</mi><mo>+</mo><mn>1</mn></mrow></msub><mo>=</mo><mfrac><mn>1</mn><mi>n</mi></mfrac><msub><mi>T</mi><mi>n</mi></msub><mo>+</mo><mfrac><mrow><mi>n</mi><mo>&amp;#x2212;</mo><mn>1</mn></mrow><mi>n</mi></mfrac><msub><mi>S</mi><mi>n</mi></msub></math>" role="presentation" style="font-size: 119%; position: relative;"><span id="MJXc-Node-340" class="mjx-math" aria-hidden="true"><span id="MJXc-Node-341" class="mjx-mrow"><span id="MJXc-Node-342" class="mjx-msubsup"><span class="mjx-base" style="margin-right: -0.032em;"><span id="MJXc-Node-343" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.475em; padding-bottom: 0.318em; padding-right: 0.032em;">S</span></span></span><span class="mjx-sub" style="font-size: 70.7%; vertical-align: -0.212em; padding-right: 0.071em;"><span id="MJXc-Node-344" class="mjx-texatom" style=""><span id="MJXc-Node-345" class="mjx-mrow"><span id="MJXc-Node-346" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.213em; padding-bottom: 0.265em;">n</span></span><span id="MJXc-Node-347" class="mjx-mo"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.318em; padding-bottom: 0.423em;">+</span></span><span id="MJXc-Node-348" class="mjx-mn"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.37em; padding-bottom: 0.318em;">1</span></span></span></span></span></span><span id="MJXc-Node-349" class="mjx-mo MJXc-space3"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.055em; padding-bottom: 0.318em;">=</span></span><span id="MJXc-Node-350" class="mjx-mfrac MJXc-space3"><span class="mjx-box MJXc-stacked" style="width: 0.566em; padding: 0px 0.12em;"><span class="mjx-numerator" style="font-size: 70.7%; width: 0.8em; top: -1.298em;"><span id="MJXc-Node-351" class="mjx-mn" style=""><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.37em; padding-bottom: 0.318em;">1</span></span></span><span class="mjx-denominator" style="font-size: 70.7%; width: 0.8em; bottom: -0.524em;"><span id="MJXc-Node-352" class="mjx-mi" style=""><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.213em; padding-bottom: 0.265em;">n</span></span></span><span class="mjx-line" style="border-bottom: 1.3px solid; top: -0.283em; width: 0.566em;"></span></span><span class="mjx-vsize" style="height: 1.288em; vertical-align: -0.37em;"></span></span><span id="MJXc-Node-353" class="mjx-msubsup"><span class="mjx-base" style="margin-right: -0.12em;"><span id="MJXc-Node-354" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.475em; padding-bottom: 0.265em; padding-right: 0.12em;">T</span></span></span><span class="mjx-sub" style="font-size: 70.7%; vertical-align: -0.212em; padding-right: 0.071em;"><span id="MJXc-Node-355" class="mjx-mi" style=""><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.213em; padding-bottom: 0.265em;">n</span></span></span></span><span id="MJXc-Node-356" class="mjx-mo MJXc-space2"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.318em; padding-bottom: 0.423em;">+</span></span><span id="MJXc-Node-357" class="mjx-mfrac MJXc-space2"><span class="mjx-box MJXc-stacked" style="width: 1.469em; padding: 0px 0.12em;"><span class="mjx-numerator" style="font-size: 70.7%; width: 2.078em; top: -1.38em;"><span id="MJXc-Node-358" class="mjx-mrow" style=""><span id="MJXc-Node-359" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.213em; padding-bottom: 0.265em;">n</span></span><span id="MJXc-Node-360" class="mjx-mo"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.318em; padding-bottom: 0.423em;">−</span></span><span id="MJXc-Node-361" class="mjx-mn"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.37em; padding-bottom: 0.318em;">1</span></span></span></span><span class="mjx-denominator" style="font-size: 70.7%; width: 2.078em; bottom: -0.524em;"><span id="MJXc-Node-362" class="mjx-mi" style=""><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.213em; padding-bottom: 0.265em;">n</span></span></span><span class="mjx-line" style="border-bottom: 1.3px solid; top: -0.283em; width: 1.469em;"></span></span><span class="mjx-vsize" style="height: 1.346em; vertical-align: -0.37em;"></span></span><span id="MJXc-Node-363" class="mjx-msubsup"><span class="mjx-base" style="margin-right: -0.032em;"><span id="MJXc-Node-364" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.475em; padding-bottom: 0.318em; padding-right: 0.032em;">S</span></span></span><span class="mjx-sub" style="font-size: 70.7%; vertical-align: -0.212em; padding-right: 0.071em;"><span id="MJXc-Node-365" class="mjx-mi" style=""><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.213em; padding-bottom: 0.265em;">n</span></span></span></span></span></span><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>S</mi><mrow class="MJX-TeXAtom-ORD"><mi>n</mi><mo>+</mo><mn>1</mn></mrow></msub><mo>=</mo><mfrac><mn>1</mn><mi>n</mi></mfrac><msub><mi>T</mi><mi>n</mi></msub><mo>+</mo><mfrac><mrow><mi>n</mi><mo>−</mo><mn>1</mn></mrow><mi>n</mi></mfrac><msub><mi>S</mi><mi>n</mi></msub></math></span></span><script type="math/tex" id="MathJax-Element-40">S_{n + 1} = \frac{1}{n} T_n + \frac{n - 1}{n} S_n</script></span><br>
<span>No i jak będziemy męczyć to dalej to wychodzi nam wykładnicze uśrednianie</span></li>
<li><span>nasz szukany wzorek to </span><span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span id="MathJax-Element-41-Frame" class="mjx-chtml MathJax_CHTML" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>S</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>n</mi><mo>+</mo><mn>1</mn></mrow></msub><mo>=</mo><mfrac><mrow><mo stretchy=&quot;false&quot;>(</mo><msub><mi>S</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>n</mi></mrow></msub><mo>&amp;#x2217;</mo><mi>&amp;#x03B1;</mi><mo>+</mo><msub><mi>T</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>n</mi></mrow></msub><mo>&amp;#x2217;</mo><msup><mn>2</mn><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn>8</mn></mrow></msup><mo>&amp;#x2217;</mo><mo stretchy=&quot;false&quot;>(</mo><msup><mn>2</mn><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn>8</mn></mrow></msup><mo>&amp;#x2212;</mo><mi>&amp;#x03B1;</mi><mo stretchy=&quot;false&quot;>)</mo><mo stretchy=&quot;false&quot;>)</mo></mrow><msup><mn>2</mn><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn>11</mn></mrow></msup></mfrac></math>" role="presentation" style="font-size: 119%; position: relative;"><span id="MJXc-Node-366" class="mjx-math" aria-hidden="true"><span id="MJXc-Node-367" class="mjx-mrow"><span id="MJXc-Node-368" class="mjx-msubsup"><span class="mjx-base" style="margin-right: -0.032em;"><span id="MJXc-Node-369" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.475em; padding-bottom: 0.318em; padding-right: 0.032em;">S</span></span></span><span class="mjx-sub" style="font-size: 70.7%; vertical-align: -0.212em; padding-right: 0.071em;"><span id="MJXc-Node-370" class="mjx-texatom" style=""><span id="MJXc-Node-371" class="mjx-mrow"><span id="MJXc-Node-372" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.213em; padding-bottom: 0.265em;">n</span></span><span id="MJXc-Node-373" class="mjx-mo"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.318em; padding-bottom: 0.423em;">+</span></span><span id="MJXc-Node-374" class="mjx-mn"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.37em; padding-bottom: 0.318em;">1</span></span></span></span></span></span><span id="MJXc-Node-375" class="mjx-mo MJXc-space3"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.055em; padding-bottom: 0.318em;">=</span></span><span id="MJXc-Node-376" class="mjx-mfrac MJXc-space3"><span class="mjx-box MJXc-stacked" style="width: 7.061em; padding: 0px 0.12em;"><span class="mjx-numerator" style="font-size: 70.7%; width: 9.986em; top: -1.763em;"><span id="MJXc-Node-377" class="mjx-mrow" style=""><span id="MJXc-Node-378" class="mjx-mo"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.475em; padding-bottom: 0.58em;">(</span></span><span id="MJXc-Node-379" class="mjx-msubsup"><span class="mjx-base" style="margin-right: -0.032em;"><span id="MJXc-Node-380" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.475em; padding-bottom: 0.318em; padding-right: 0.032em;">S</span></span></span><span class="mjx-sub" style="font-size: 70.7%; vertical-align: -0.212em; padding-right: 0.071em;"><span id="MJXc-Node-381" class="mjx-texatom" style=""><span id="MJXc-Node-382" class="mjx-mrow"><span id="MJXc-Node-383" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.213em; padding-bottom: 0.265em;">n</span></span></span></span></span></span><span id="MJXc-Node-384" class="mjx-mo"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.16em; padding-bottom: 0.318em;">∗</span></span><span id="MJXc-Node-385" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.213em; padding-bottom: 0.265em;">α</span></span><span id="MJXc-Node-386" class="mjx-mo"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.318em; padding-bottom: 0.423em;">+</span></span><span id="MJXc-Node-387" class="mjx-msubsup"><span class="mjx-base" style="margin-right: -0.12em;"><span id="MJXc-Node-388" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.475em; padding-bottom: 0.265em; padding-right: 0.12em;">T</span></span></span><span class="mjx-sub" style="font-size: 70.7%; vertical-align: -0.212em; padding-right: 0.071em;"><span id="MJXc-Node-389" class="mjx-texatom" style=""><span id="MJXc-Node-390" class="mjx-mrow"><span id="MJXc-Node-391" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.213em; padding-bottom: 0.265em;">n</span></span></span></span></span></span><span id="MJXc-Node-392" class="mjx-mo"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.16em; padding-bottom: 0.318em;">∗</span></span><span id="MJXc-Node-393" class="mjx-msubsup"><span class="mjx-base"><span id="MJXc-Node-394" class="mjx-mn"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.37em; padding-bottom: 0.318em;">2</span></span></span><span class="mjx-sup" style="font-size: 70.7%; vertical-align: 0.591em; padding-left: 0px; padding-right: 0.071em;"><span id="MJXc-Node-395" class="mjx-texatom" style=""><span id="MJXc-Node-396" class="mjx-mrow"><span id="MJXc-Node-397" class="mjx-mn"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.37em; padding-bottom: 0.37em;">8</span></span></span></span></span></span><span id="MJXc-Node-398" class="mjx-mo"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.16em; padding-bottom: 0.318em;">∗</span></span><span id="MJXc-Node-399" class="mjx-mo"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.475em; padding-bottom: 0.58em;">(</span></span><span id="MJXc-Node-400" class="mjx-msubsup"><span class="mjx-base"><span id="MJXc-Node-401" class="mjx-mn"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.37em; padding-bottom: 0.318em;">2</span></span></span><span class="mjx-sup" style="font-size: 70.7%; vertical-align: 0.591em; padding-left: 0px; padding-right: 0.071em;"><span id="MJXc-Node-402" class="mjx-texatom" style=""><span id="MJXc-Node-403" class="mjx-mrow"><span id="MJXc-Node-404" class="mjx-mn"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.37em; padding-bottom: 0.37em;">8</span></span></span></span></span></span><span id="MJXc-Node-405" class="mjx-mo"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.318em; padding-bottom: 0.423em;">−</span></span><span id="MJXc-Node-406" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.213em; padding-bottom: 0.265em;">α</span></span><span id="MJXc-Node-407" class="mjx-mo"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.475em; padding-bottom: 0.58em;">)</span></span><span id="MJXc-Node-408" class="mjx-mo"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.475em; padding-bottom: 0.58em;">)</span></span></span></span><span class="mjx-denominator" style="font-size: 70.7%; width: 9.986em; bottom: -0.806em;"><span id="MJXc-Node-409" class="mjx-msubsup" style=""><span class="mjx-base"><span id="MJXc-Node-410" class="mjx-mn"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.37em; padding-bottom: 0.318em;">2</span></span></span><span class="mjx-sup" style="font-size: 70.7%; vertical-align: 0.591em; padding-left: 0px; padding-right: 0.071em;"><span id="MJXc-Node-411" class="mjx-texatom" style=""><span id="MJXc-Node-412" class="mjx-mrow"><span id="MJXc-Node-413" class="mjx-mn"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.37em; padding-bottom: 0.318em;">11</span></span></span></span></span></span></span><span class="mjx-line" style="border-bottom: 1.3px solid; top: -0.283em; width: 7.061em;"></span></span><span class="mjx-vsize" style="height: 1.817em; vertical-align: -0.57em;"></span></span></span></span><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>S</mi><mrow class="MJX-TeXAtom-ORD"><mi>n</mi><mo>+</mo><mn>1</mn></mrow></msub><mo>=</mo><mfrac><mrow><mo stretchy="false">(</mo><msub><mi>S</mi><mrow class="MJX-TeXAtom-ORD"><mi>n</mi></mrow></msub><mo>∗</mo><mi>α</mi><mo>+</mo><msub><mi>T</mi><mrow class="MJX-TeXAtom-ORD"><mi>n</mi></mrow></msub><mo>∗</mo><msup><mn>2</mn><mrow class="MJX-TeXAtom-ORD"><mn>8</mn></mrow></msup><mo>∗</mo><mo stretchy="false">(</mo><msup><mn>2</mn><mrow class="MJX-TeXAtom-ORD"><mn>8</mn></mrow></msup><mo>−</mo><mi>α</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><msup><mn>2</mn><mrow class="MJX-TeXAtom-ORD"><mn>11</mn></mrow></msup></mfrac></math></span></span><script type="math/tex" id="MathJax-Element-41">S_{n+1} = \frac{(S_{n} * \alpha + T_{n} * 2^{8} * (2^{8} - \alpha))}{2^{11}}</script></span></li>
</ul><p><img src="https://i.imgur.com/jeKhgtq.png" alt=""></p><p><a href="http://bxr.su/FreeBSD/sys/kern/kern_synch.c#cexp" target="_blank" rel="noopener"><code>cexp</code></a></p><pre><code class="C hljs"><div class="wrapper"><div class="gutter linenumber"><span data-linenumber="1"></span>
<span data-linenumber="2"></span>
<span data-linenumber="3"></span>
<span data-linenumber="4"></span>
<span data-linenumber="5"></span>
<span data-linenumber="6"></span>
<span data-linenumber="7"></span>
<span data-linenumber="8"></span>
<span data-linenumber="9"></span></div><div class="code">/*
 * Constants <span class="hljs-keyword">for</span> averages over <span class="hljs-number">1</span>, <span class="hljs-number">5</span>, <span class="hljs-keyword">and</span> <span class="hljs-number">15</span> minutes
 * <span class="hljs-keyword">when</span> sampling at <span class="hljs-number">5</span> second intervals.
 *<span class="hljs-regexp">/
static fixpt_t cexp[3] = {
    0.9200444146293232 * FSCALE,    /</span>* <span class="hljs-keyword">exp</span>(-<span class="hljs-number">1</span>/<span class="hljs-number">12</span>) *<span class="hljs-regexp">/
    0.9834714538216174 * FSCALE,    /</span>* <span class="hljs-keyword">exp</span>(-<span class="hljs-number">1</span>/<span class="hljs-number">60</span>) *<span class="hljs-regexp">/
    0.9944598480048967 * FSCALE,    /</span>* <span class="hljs-keyword">exp</span>(-<span class="hljs-number">1</span>/<span class="hljs-number">180</span>) *<span class="hljs-regexp">/
};
</span></div></div></code></pre><p><a href="http://bxr.su/FreeBSD/sys/kern/kern_synch.c#loadav" target="_blank" rel="noopener"><code>loadav</code></a></p><pre><code class="C hljs"><div class="wrapper"><div class="gutter linenumber"><span data-linenumber="608"></span>
<span data-linenumber="609"></span>
<span data-linenumber="610"></span>
<span data-linenumber="611"></span>
<span data-linenumber="612"></span>
<span data-linenumber="613"></span>
<span data-linenumber="614"></span>
<span data-linenumber="615"></span>
<span data-linenumber="616"></span>
<span data-linenumber="617"></span>
<span data-linenumber="618"></span>
<span data-linenumber="619"></span>
<span data-linenumber="620"></span>
<span data-linenumber="621"></span>
<span data-linenumber="622"></span>
<span data-linenumber="623"></span>
<span data-linenumber="624"></span>
<span data-linenumber="625"></span>
<span data-linenumber="626"></span>
<span data-linenumber="627"></span>
<span data-linenumber="628"></span>
<span data-linenumber="629"></span></div><div class="code"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span>
<span class="hljs-title">loadav</span>(<span class="hljs-params"><span class="hljs-keyword">void</span> *arg</span>)
</span>{
    <span class="hljs-keyword">int</span> i, nrun;
    <span class="hljs-keyword">struct</span> loadavg *avg;

    nrun = sched_load();
    avg = &amp;averunnable;

    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++)
        avg-&gt;ldavg[i] = (cexp[i] * avg-&gt;ldavg[i] +
            nrun * FSCALE * (FSCALE - cexp[i])) &gt;&gt; FSHIFT;

    <span class="hljs-comment">/*
     * Schedule the next update to occur after 5 seconds, but add a
     * random variation to avoid synchronisation with processes that
     * run at regular intervals.
     */</span>
    callout_reset_sbt(&amp;loadav_callout,
        SBT_1US * (<span class="hljs-number">4000000</span> + (<span class="hljs-keyword">int</span>)(random() % <span class="hljs-number">2000001</span>)), SBT_1US,
        loadav, NULL, C_DIRECT_EXEC | C_PREL(<span class="hljs-number">32</span>));
}
</div></div></code></pre><h2 id="Zadanie-2" data-id="Zadanie-2"><a class="anchor hidden-xs" href="#Zadanie-2" title="Zadanie-2"><span class="octicon octicon-link"></span></a><span>Zadanie 2.</span></h2><ul>
<li><span>planista długoterminowy</span></li>
<li><span>kolejki wątków</span></li>
<li><span>wyznaczanie priorytetów</span></li>
<li><a href="http://bxr.su/NetBSD/sys/kern/sched_4bsd.c#190" target="_blank" rel="noopener"><span>sposób wyznaczania obciążenia</span></a></li>
</ul><p><span>Tradycyjny scheduler był używany w SVR3 i w 4.3 BSD UNIX. Te systemy były przeznaczone do dzielących się czasem interaktywnych środowisk. Algorytm schdulera był zaprojektowany aby oferować dobrą responsywność dla interaktywnych użytkoników jednocześnie dbając o to, aby zadania pracujące w tle o niskim priorytecie nie były głodzone.</span></p><p><span>Co sekundę wykonujemy wywłaszczania. Jeśli proces nie blokuje albo nie zakończył się to jest wywłaszczany.</span></p><p><span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span class="mjx-chtml MJXc-display"><span id="MathJax-Element-42-Frame" class="mjx-full-width mjx-chtml MathJax_CHTML" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mi>C</mi><mi>P</mi><msub><mi>U</mi><mi>j</mi></msub><mo stretchy=&quot;false&quot;>(</mo><mi>i</mi><mo stretchy=&quot;false&quot;>)</mo><mo>=</mo><mfrac><mrow><mi>C</mi><mi>P</mi><msub><mi>U</mi><mi>j</mi></msub><mo stretchy=&quot;false&quot;>(</mo><mi>i</mi><mo>&amp;#x2212;</mo><mn>1</mn><mo stretchy=&quot;false&quot;>)</mo></mrow><mn>2</mn></mfrac><mspace linebreak=&quot;newline&quot; /><msub><mi>P</mi><mi>j</mi></msub><mo stretchy=&quot;false&quot;>(</mo><mi>i</mi><mo stretchy=&quot;false&quot;>)</mo><mo>=</mo><mi>B</mi><mi>a</mi><mi>s</mi><msub><mi>e</mi><mi>j</mi></msub><mo>+</mo><mfrac><mrow><mi>C</mi><mi>P</mi><msub><mi>U</mi><mi>j</mi></msub><mo stretchy=&quot;false&quot;>(</mo><mi>i</mi><mo stretchy=&quot;false&quot;>)</mo></mrow><mn>2</mn></mfrac><mo>+</mo><mi>n</mi><mi>i</mi><mi>c</mi><msub><mi>e</mi><mi>j</mi></msub></math>" role="presentation" style="font-size: 119%; min-width: 14.674em; position: relative;"><span id="MJXc-Node-414" class="mjx-math" aria-hidden="true" style="width: 100%;"><span id="MJXc-Node-415" class="mjx-mrow" style="width: 100%;"><span class="mjx-stack" style="width: 100%; vertical-align: -2.714em;"><span class="mjx-block" style="text-align: center;"><span class="mjx-box"><span id="MJXc-Node-416" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.475em; padding-bottom: 0.318em; padding-right: 0.045em;">C</span></span><span id="MJXc-Node-417" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.475em; padding-bottom: 0.265em; padding-right: 0.109em;">P</span></span><span id="MJXc-Node-418" class="mjx-msubsup"><span class="mjx-base" style="margin-right: -0.084em;"><span id="MJXc-Node-419" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.475em; padding-bottom: 0.318em; padding-right: 0.084em;">U</span></span></span><span class="mjx-sub" style="font-size: 70.7%; vertical-align: -0.212em; padding-right: 0.071em;"><span id="MJXc-Node-420" class="mjx-mi" style=""><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.423em; padding-bottom: 0.475em;">j</span></span></span></span><span id="MJXc-Node-421" class="mjx-mo"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.475em; padding-bottom: 0.58em;">(</span></span><span id="MJXc-Node-422" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.423em; padding-bottom: 0.265em;">i</span></span><span id="MJXc-Node-423" class="mjx-mo"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.475em; padding-bottom: 0.58em;">)</span></span><span id="MJXc-Node-424" class="mjx-mo MJXc-space3"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.055em; padding-bottom: 0.318em;">=</span></span><span id="MJXc-Node-425" class="mjx-mfrac MJXc-space3"><span class="mjx-box MJXc-stacked" style="width: 5.566em; padding: 0px 0.12em;"><span class="mjx-numerator" style="width: 5.566em; top: -1.561em;"><span id="MJXc-Node-426" class="mjx-mrow"><span id="MJXc-Node-427" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.475em; padding-bottom: 0.318em; padding-right: 0.045em;">C</span></span><span id="MJXc-Node-428" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.475em; padding-bottom: 0.265em; padding-right: 0.109em;">P</span></span><span id="MJXc-Node-429" class="mjx-msubsup"><span class="mjx-base" style="margin-right: -0.084em;"><span id="MJXc-Node-430" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.475em; padding-bottom: 0.318em; padding-right: 0.084em;">U</span></span></span><span class="mjx-sub" style="font-size: 70.7%; vertical-align: -0.212em; padding-right: 0.071em;"><span id="MJXc-Node-431" class="mjx-mi" style=""><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.423em; padding-bottom: 0.475em;">j</span></span></span></span><span id="MJXc-Node-432" class="mjx-mo"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.475em; padding-bottom: 0.58em;">(</span></span><span id="MJXc-Node-433" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.423em; padding-bottom: 0.265em;">i</span></span><span id="MJXc-Node-434" class="mjx-mo MJXc-space2"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.318em; padding-bottom: 0.423em;">−</span></span><span id="MJXc-Node-435" class="mjx-mn MJXc-space2"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.37em; padding-bottom: 0.318em;">1</span></span><span id="MJXc-Node-436" class="mjx-mo"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.475em; padding-bottom: 0.58em;">)</span></span></span></span><span class="mjx-denominator" style="width: 5.566em; bottom: -0.711em;"><span id="MJXc-Node-437" class="mjx-mn"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.37em; padding-bottom: 0.318em;">2</span></span></span><span class="mjx-line" style="border-bottom: 1.3px solid; top: -0.283em; width: 5.566em;"></span></span><span class="mjx-vsize" style="height: 2.272em; vertical-align: -0.711em;"></span></span></span></span><span class="mjx-block" style="text-align: center; padding-top: 0.442em;"><span class="mjx-box"><span id="MJXc-Node-438" class="mjx-mspace" style="width: 0px; height: 0px;"></span><span id="MJXc-Node-439" class="mjx-msubsup"><span class="mjx-base" style="margin-right: -0.109em;"><span id="MJXc-Node-440" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.475em; padding-bottom: 0.265em; padding-right: 0.109em;">P</span></span></span><span class="mjx-sub" style="font-size: 70.7%; vertical-align: -0.212em; padding-right: 0.071em;"><span id="MJXc-Node-441" class="mjx-mi" style=""><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.423em; padding-bottom: 0.475em;">j</span></span></span></span><span id="MJXc-Node-442" class="mjx-mo"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.475em; padding-bottom: 0.58em;">(</span></span><span id="MJXc-Node-443" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.423em; padding-bottom: 0.265em;">i</span></span><span id="MJXc-Node-444" class="mjx-mo"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.475em; padding-bottom: 0.58em;">)</span></span><span id="MJXc-Node-445" class="mjx-mo MJXc-space3"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.055em; padding-bottom: 0.318em;">=</span></span><span id="MJXc-Node-446" class="mjx-mi MJXc-space3"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.475em; padding-bottom: 0.265em;">B</span></span><span id="MJXc-Node-447" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.213em; padding-bottom: 0.265em;">a</span></span><span id="MJXc-Node-448" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.213em; padding-bottom: 0.265em;">s</span></span><span id="MJXc-Node-449" class="mjx-msubsup"><span class="mjx-base"><span id="MJXc-Node-450" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.213em; padding-bottom: 0.265em;">e</span></span></span><span class="mjx-sub" style="font-size: 70.7%; vertical-align: -0.212em; padding-right: 0.071em;"><span id="MJXc-Node-451" class="mjx-mi" style=""><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.423em; padding-bottom: 0.475em;">j</span></span></span></span><span id="MJXc-Node-452" class="mjx-mo MJXc-space2"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.318em; padding-bottom: 0.423em;">+</span></span><span id="MJXc-Node-453" class="mjx-mfrac MJXc-space2"><span class="mjx-box MJXc-stacked" style="width: 3.844em; padding: 0px 0.12em;"><span class="mjx-numerator" style="width: 3.844em; top: -1.561em;"><span id="MJXc-Node-454" class="mjx-mrow"><span id="MJXc-Node-455" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.475em; padding-bottom: 0.318em; padding-right: 0.045em;">C</span></span><span id="MJXc-Node-456" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.475em; padding-bottom: 0.265em; padding-right: 0.109em;">P</span></span><span id="MJXc-Node-457" class="mjx-msubsup"><span class="mjx-base" style="margin-right: -0.084em;"><span id="MJXc-Node-458" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.475em; padding-bottom: 0.318em; padding-right: 0.084em;">U</span></span></span><span class="mjx-sub" style="font-size: 70.7%; vertical-align: -0.212em; padding-right: 0.071em;"><span id="MJXc-Node-459" class="mjx-mi" style=""><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.423em; padding-bottom: 0.475em;">j</span></span></span></span><span id="MJXc-Node-460" class="mjx-mo"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.475em; padding-bottom: 0.58em;">(</span></span><span id="MJXc-Node-461" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.423em; padding-bottom: 0.265em;">i</span></span><span id="MJXc-Node-462" class="mjx-mo"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.475em; padding-bottom: 0.58em;">)</span></span></span></span><span class="mjx-denominator" style="width: 3.844em; bottom: -0.711em;"><span id="MJXc-Node-463" class="mjx-mn"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.37em; padding-bottom: 0.318em;">2</span></span></span><span class="mjx-line" style="border-bottom: 1.3px solid; top: -0.283em; width: 3.844em;"></span></span><span class="mjx-vsize" style="height: 2.272em; vertical-align: -0.711em;"></span></span><span id="MJXc-Node-464" class="mjx-mo MJXc-space2"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.318em; padding-bottom: 0.423em;">+</span></span><span id="MJXc-Node-465" class="mjx-mi MJXc-space2"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.213em; padding-bottom: 0.265em;">n</span></span><span id="MJXc-Node-466" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.423em; padding-bottom: 0.265em;">i</span></span><span id="MJXc-Node-467" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.213em; padding-bottom: 0.265em;">c</span></span><span id="MJXc-Node-468" class="mjx-msubsup"><span class="mjx-base"><span id="MJXc-Node-469" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.213em; padding-bottom: 0.265em;">e</span></span></span><span class="mjx-sub" style="font-size: 70.7%; vertical-align: -0.212em; padding-right: 0.071em;"><span id="MJXc-Node-470" class="mjx-mi" style=""><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.423em; padding-bottom: 0.475em;">j</span></span></span></span></span></span></span></span></span><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mi>C</mi><mi>P</mi><msub><mi>U</mi><mi>j</mi></msub><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mrow><mi>C</mi><mi>P</mi><msub><mi>U</mi><mi>j</mi></msub><mo stretchy="false">(</mo><mi>i</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><mn>2</mn></mfrac><mspace linebreak="newline"></mspace><msub><mi>P</mi><mi>j</mi></msub><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo><mo>=</mo><mi>B</mi><mi>a</mi><mi>s</mi><msub><mi>e</mi><mi>j</mi></msub><mo>+</mo><mfrac><mrow><mi>C</mi><mi>P</mi><msub><mi>U</mi><mi>j</mi></msub><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow><mn>2</mn></mfrac><mo>+</mo><mi>n</mi><mi>i</mi><mi>c</mi><msub><mi>e</mi><mi>j</mi></msub></math></span></span></span><script type="math/tex; mode=display" id="MathJax-Element-42">CPU_j(i) = \frac{CPU_j(i - 1)}{2} \\
P_j(i) = Base_j + \frac{CPU_j(i)}{2} + nice_j</script></span></p><p><span>gdzie </span><span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span id="MathJax-Element-43-Frame" class="mjx-chtml MathJax_CHTML" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>C</mi><mi>P</mi><msub><mi>U</mi><mi>j</mi></msub><mo stretchy=&quot;false&quot;>(</mo><mi>i</mi><mo stretchy=&quot;false&quot;>)</mo></math>" role="presentation" style="font-size: 119%; position: relative;"><span id="MJXc-Node-471" class="mjx-math" aria-hidden="true"><span id="MJXc-Node-472" class="mjx-mrow"><span id="MJXc-Node-473" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.475em; padding-bottom: 0.318em; padding-right: 0.045em;">C</span></span><span id="MJXc-Node-474" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.475em; padding-bottom: 0.265em; padding-right: 0.109em;">P</span></span><span id="MJXc-Node-475" class="mjx-msubsup"><span class="mjx-base" style="margin-right: -0.084em;"><span id="MJXc-Node-476" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.475em; padding-bottom: 0.318em; padding-right: 0.084em;">U</span></span></span><span class="mjx-sub" style="font-size: 70.7%; vertical-align: -0.212em; padding-right: 0.071em;"><span id="MJXc-Node-477" class="mjx-mi" style=""><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.423em; padding-bottom: 0.475em;">j</span></span></span></span><span id="MJXc-Node-478" class="mjx-mo"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.475em; padding-bottom: 0.58em;">(</span></span><span id="MJXc-Node-479" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.423em; padding-bottom: 0.265em;">i</span></span><span id="MJXc-Node-480" class="mjx-mo"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.475em; padding-bottom: 0.58em;">)</span></span></span></span><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>C</mi><mi>P</mi><msub><mi>U</mi><mi>j</mi></msub><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-43">CPU_j(i)</script></span><span> służy do pomiaru utylizacji przez proces j w przedziale czasowym i</span><br>
<span>P to priorytet (niski = lepszy), Base to bazowy priorytet, nice to czynnik nice</span></p><p><strong><span>Uwaga:</span></strong><span> ten wzorek jest przepisany z książki, ale nie działa. Powinniśmy jeszcze dodawać jakąś wartość odzwierciedlającą czas wykonania się na procesorze. (tak jak to jest na rysunku niżej)</span></p><p><span>Priorytet bazowy wsadza nam procesy do pewnych kubełków, tak aby była znana ich ważność dla jądra, CPU i nice nie pozwolą nam wyskakiwać do inncyh kubełków.</span></p><p><span>W kolejności malejących priorytetów</span></p><ul>
<li><span>swapper</span></li>
<li><span>block I/O device control</span></li>
<li><span>file manipulation</span></li>
<li><span>character I/O device control</span></li>
<li><span>user processes</span></li>
</ul><p><span>No i robimy to głównie dlatego, aby zoptymalizować takie rzeczy jak I/O czy syscalle.</span></p><p><img src="https://i.imgur.com/EXBti5X.png" alt=""></p><p><span>No to procedurka która nam wyznacza zużycie CPU dostaje </span><em><span>l_estcpu</span></em><span> jako argument i na jego podstawie sobie liczy.</span></p><p><em><span>l_estcpu</span></em><span> jest</span><br>
<span>- zwiększany za każdym razem gdzy podczas </span><em><span>hardclock</span></em><span> wątek jest wykonywany </span><em><span>sched_schedclock</span></em><br>
<span>- zmniejszany na każdy tick schedulera </span><em><span>sched_pstats_hook</span></em><br>
<span>jeśli watek śpi dłużej niż sekundę, nie dotykamy </span><em><span>l_estcpu</span></em></p><p><span>Najpierw wywalamy 90% </span><em><span>l_estcpu</span></em><span> z 5 * loadavg</span><br>
<span>czyli kończymy z l_estcpu *= 0.1 dla wszystkich loadavg</span><br>
<span>a póxniej liczymy sobie decay = (2 * loadavg) / (2 * loadavg + 1)</span></p><p><span>I mówimy, że decay ** (5 * loadavg) ~= .1</span></p><h2 id="Zadanie-3" data-id="Zadanie-3"><a class="anchor hidden-xs" href="#Zadanie-3" title="Zadanie-3"><span class="octicon octicon-link"></span></a><span>Zadanie 3.</span></h2><p><span>Więc zgodnie z książką w Linuxie mamy trzy typy schedulingu</span></p><ul>
<li><span>SCHED_FIFO – first-in-first-out real-time threads</span></li>
<li><span>SCHED_RR – round-robin real-time threads (0-99 priorytety)</span></li>
<li><span>SCHED_OTHER – other, non-real-time threads (100-139 priorytety)</span></li>
</ul><p><span>Dla wątków FIFO mamy co następuje:</span></p><ol>
<li><span>System nie prezrywa wątków FIFO poza następującymi przypadkami:</span>
<ul>
<li><span>inny wątek FIFO z wyższym priorytetem staje się gotowy</span></li>
<li><span>wykonywanie wątku FIFO zostało zablokowane przez czekanie na event, np. I/O</span></li>
<li><span>wątek dobrowolnie oddał procesor używając </span><em><span>sched_yield</span></em></li>
</ul>
</li>
<li><span>Kiedy wątek został przerwany zostaje odłożony na kolejkę wątków o swoim priorytecie</span></li>
<li><span>Jeśli wątek stanie się gotowym do działania i ma wyższy priorytet od wątku, który jest aktualnie wykonywany, to wątek zostaje ściągniety z CPU i my zajmiemy jego miejsce (chyba, że jest inny wątek o takim samym (najwyższym) priorytecie, wtedy ten który czekał dłużej zajmie CPU)</span></li>
</ol><p><span>Dla wątków real-time jest podobnie, wsadzamy je na CPU na pewien określony czas, a następnie zostają zastąpione przez inny, który miał większy/równy priorytet (tutaj robimy wywłaszczanie).</span></p><p><img src="https://i.imgur.com/pnHmrtu.png" alt=""></p><p><span>A co z non-real-time schedulingiem?</span></p><p><span>Linux 2.4 słabo się skalował.</span></p><ul>
<li><span>jedna runqueue dla wszystkich procesorów – czyli procesy schedulowały się trochę losowo na procesorach – czyli było bardzo smutno dla cache</span></li>
<li><span>jeden lock na runqueue – no to bardzo słabe, bo jak wszystkie CPU zmieniają sobie proces to czekają</span></li>
<li><span>wywłaszczanie nie było możliwe (tak jest napisane w książce, nie żartuję)</span></li>
</ul><p><span>I dlatego w 2.6 niczym rycerz na białym koniu pojawił się scheduler O(1). Nazwa wzięła się stąd, że został zaprojektowany do bycia szybciutkim.</span></p><p><span>Kernel ma sobie dwie strukturki dla każdego procesora</span></p><pre><code class="C hljs"><span class="hljs-keyword">struct</span> prio_array {
    <span class="hljs-keyword">int</span> nr_active; <span class="hljs-comment">/* number of tasks in this array */</span>
    unsigned <span class="hljs-keyword">long</span> bitmap[BITMAP_SIZE]; <span class="hljs-comment">/* priority bitmap */</span>
    <span class="hljs-keyword">struct</span> list_head queue[MAX_PRIO]; <span class="hljs-comment">/* priority queues */</span>
}
</code></pre><p><span>Tak więc mamy osobną kolejkę dla każdego możliwego priorytetu (domyślnie 140). Natomiast bitmapa ma rozmiar 5 i określa które kolejki są niepuste. I mamy aktywne i expired (jak to się na polski tłumaczy???) kolejki.</span></p><p><span>Kiedy proces stanie się gotowy do działania, jest wrzucany na odpowiednią kolejkę. Jeśli został wywłaszczony przed swoim kwantem czasu to ponownie wrzucamy go na aktywną kolejkę. W innym wypadku wrzucamy go na kolejkę expired i będziemy dawać mu nowy kwant czasu w przyszłości.</span></p><p><span>Wykonujemy więc zadania w kolejności od największego priorytetu (jak jest wiele to round-robin).</span></p><p><span>Dodatkowo czasem scheduler patrzy na kolejki innych CPU i jeśli uzna, że są bardzo nierówno rozstawione to “rozrzuca” taski na inne CPU (w pierwszej kolejności te z dużym priorytetem, które są aktywne).</span></p><p><img src="https://i.imgur.com/oI1Ksy9.png" alt=""></p><p><span>Okazuje się, że to podejście miało jednak pewne problemy związane z heurystyką, która liczyła sobie interaktywność taska a więc jego priorytet. Efektem były poor performance dla interaktwynych tasków.</span></p><p><span>Dlatego Ingo Molnar (twórca O(1)) wymyślił sobie </span><em><span>Completely Fair Scheduler</span></em><span> (</span><em><span>CFS</span></em><span>).</span></p><p><span>W </span><em><span>CFS</span></em><span> runqueue są reprezentowane jako drzewa czerwono czarne. Są one sortowane (w sensie operator porównujący w środku) przez czas spędzony przez proces na CPU (</span><em><span>vruntime</span></em><span>).</span></p><p><img src="https://i.imgur.com/37XRc44.png" alt=""></p><p><span>No i tutaj robimy po prostu co jakiś czas update </span><em><span>vruntime</span></em><span> i wybieramy najbardziej po lewej wierzchołek i jego schedulujemy.</span></p><p><span>No i jest taka uwaga, że taski z mniejszym priorytetem mają częściej przydzielany czas a ich </span><em><span>vruntime</span></em><span> rośnie szybciej.</span></p><h2 id="Zadanie-4" data-id="Zadanie-4"><a class="anchor hidden-xs" href="#Zadanie-4" title="Zadanie-4"><span class="octicon octicon-link"></span></a><span>Zadanie 4.</span></h2><p><span>Wzór na </span><em><span>interactivity score</span></em><span> bierzemy z </span><a href="http://bxr.su/FreeBSD/sys/kern/sched_ule.c#sched_interact_score" target="_blank" rel="noopener"><em><span>sched_interact_score</span></em></a></p><p><span>Jeśli czas snu wątku był wyższy niż czas działania</span><br>
<span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span class="mjx-chtml MJXc-display" style="text-align: center;"><span id="MathJax-Element-44-Frame" class="mjx-chtml MathJax_CHTML" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mfrac><mtext>scaling factor</mtext><mrow><mtext>sleep time</mtext><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo>/</mo></mrow><mtext>run time</mtext></mrow></mfrac></math>" role="presentation" style="font-size: 119%; text-align: center; position: relative;"><span id="MJXc-Node-481" class="mjx-math" aria-hidden="true"><span id="MJXc-Node-482" class="mjx-mrow"><span id="MJXc-Node-483" class="mjx-mfrac"><span class="mjx-box MJXc-stacked" style="width: 8.708em; padding: 0px 0.12em;"><span class="mjx-numerator" style="width: 8.708em; top: -1.435em;"><span id="MJXc-Node-484" class="mjx-mtext"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.423em; padding-bottom: 0.528em;">scaling factor</span></span></span><span class="mjx-denominator" style="width: 8.708em; bottom: -1.024em;"><span id="MJXc-Node-485" class="mjx-mrow"><span id="MJXc-Node-486" class="mjx-mtext"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.423em; padding-bottom: 0.528em;">sleep time</span></span><span id="MJXc-Node-487" class="mjx-texatom"><span id="MJXc-Node-488" class="mjx-mrow"><span id="MJXc-Node-489" class="mjx-mo"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.475em; padding-bottom: 0.58em;">/</span></span></span></span><span id="MJXc-Node-490" class="mjx-mtext"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.37em; padding-bottom: 0.37em;">run time</span></span></span></span><span class="mjx-line" style="border-bottom: 1.3px solid; top: -0.283em; width: 8.708em;"></span></span><span class="mjx-vsize" style="height: 2.459em; vertical-align: -1.024em;"></span></span></span></span><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mfrac><mtext>scaling factor</mtext><mrow><mtext>sleep time</mtext><mrow class="MJX-TeXAtom-ORD"><mo>/</mo></mrow><mtext>run time</mtext></mrow></mfrac></math></span></span></span><script type="math/tex; mode=display" id="MathJax-Element-44"> \frac{\text{scaling factor}}{\text{sleep time} / \text{run time}} </script></span></p><p><span>Jeśli czas działania wątku był większy niż czas snu</span><br>
<span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span class="mjx-chtml MJXc-display" style="text-align: center;"><span id="MathJax-Element-45-Frame" class="mjx-chtml MathJax_CHTML" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mfrac><mtext>scaling factor</mtext><mrow><mtext>run time</mtext><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo>/</mo></mrow><mtext>sleep time</mtext></mrow></mfrac><mo>+</mo><mtext>scaling factor</mtext></math>" role="presentation" style="font-size: 119%; text-align: center; position: relative;"><span id="MJXc-Node-491" class="mjx-math" aria-hidden="true"><span id="MJXc-Node-492" class="mjx-mrow"><span id="MJXc-Node-493" class="mjx-mfrac"><span class="mjx-box MJXc-stacked" style="width: 8.708em; padding: 0px 0.12em;"><span class="mjx-numerator" style="width: 8.708em; top: -1.435em;"><span id="MJXc-Node-494" class="mjx-mtext"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.423em; padding-bottom: 0.528em;">scaling factor</span></span></span><span class="mjx-denominator" style="width: 8.708em; bottom: -1.024em;"><span id="MJXc-Node-495" class="mjx-mrow"><span id="MJXc-Node-496" class="mjx-mtext"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.37em; padding-bottom: 0.37em;">run time</span></span><span id="MJXc-Node-497" class="mjx-texatom"><span id="MJXc-Node-498" class="mjx-mrow"><span id="MJXc-Node-499" class="mjx-mo"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.475em; padding-bottom: 0.58em;">/</span></span></span></span><span id="MJXc-Node-500" class="mjx-mtext"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.423em; padding-bottom: 0.528em;">sleep time</span></span></span></span><span class="mjx-line" style="border-bottom: 1.3px solid; top: -0.283em; width: 8.708em;"></span></span><span class="mjx-vsize" style="height: 2.459em; vertical-align: -1.024em;"></span></span><span id="MJXc-Node-501" class="mjx-mo MJXc-space2"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.318em; padding-bottom: 0.423em;">+</span></span><span id="MJXc-Node-502" class="mjx-mtext MJXc-space2"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.423em; padding-bottom: 0.528em;">scaling factor</span></span></span></span><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mfrac><mtext>scaling factor</mtext><mrow><mtext>run time</mtext><mrow class="MJX-TeXAtom-ORD"><mo>/</mo></mrow><mtext>sleep time</mtext></mrow></mfrac><mo>+</mo><mtext>scaling factor</mtext></math></span></span></span><script type="math/tex; mode=display" id="MathJax-Element-45"> \frac{\text{scaling factor}}{\text{run time} / \text{sleep time}} + \text{scaling factor} </script></span></p><p><span>Ale uwaga!</span></p><p><span>Tutaj artykuł i komentarze robią z nas debili, bo ten kod wygląda inaczej:</span></p><p><span>Jeśli czas snu był większy niż czas działania</span><br>
<span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span class="mjx-chtml MJXc-display" style="text-align: center;"><span id="MathJax-Element-46-Frame" class="mjx-chtml MathJax_CHTML" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mfrac><mtext>run time</mtext><mfrac><mtext>sleep time</mtext><mtext>const</mtext></mfrac></mfrac></math>" role="presentation" style="font-size: 119%; text-align: center; position: relative;"><span id="MJXc-Node-503" class="mjx-math" aria-hidden="true"><span id="MJXc-Node-504" class="mjx-mrow"><span id="MJXc-Node-505" class="mjx-mfrac"><span class="mjx-box MJXc-stacked" style="width: 3.898em; padding: 0px 0.12em;"><span class="mjx-numerator" style="width: 3.898em; top: -1.371em;"><span id="MJXc-Node-506" class="mjx-mtext"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.37em; padding-bottom: 0.37em;">run time</span></span></span><span class="mjx-denominator" style="width: 3.898em; bottom: -1.438em;"><span id="MJXc-Node-507" class="mjx-mfrac"><span class="mjx-box MJXc-stacked" style="width: 3.189em; padding: 0px 0.12em;"><span class="mjx-numerator" style="font-size: 70.7%; width: 4.51em; top: -1.52em;"><span id="MJXc-Node-508" class="mjx-mtext" style=""><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.423em; padding-bottom: 0.528em;">sleep time</span></span></span><span class="mjx-denominator" style="font-size: 70.7%; width: 4.51em; bottom: -0.551em;"><span id="MJXc-Node-509" class="mjx-mtext" style=""><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.318em; padding-bottom: 0.37em;">const</span></span></span><span class="mjx-line" style="border-bottom: 1.3px solid; top: -0.283em; width: 3.189em;"></span></span><span class="mjx-vsize" style="height: 1.464em; vertical-align: -0.389em;"></span></span></span><span class="mjx-line" style="border-bottom: 1.3px solid; top: -0.283em; width: 3.898em;"></span></span><span class="mjx-vsize" style="height: 2.809em; vertical-align: -1.438em;"></span></span></span></span><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mfrac><mtext>run time</mtext><mfrac><mtext>sleep time</mtext><mtext>const</mtext></mfrac></mfrac></math></span></span></span><script type="math/tex; mode=display" id="MathJax-Element-46"> \frac{\text{run time}}{\frac{\text{sleep time}}{\text{const}}} </script></span></p><p><span>A jeśli czas działania był większy niż czas snu</span></p><p><span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span class="mjx-chtml MJXc-display" style="text-align: center;"><span id="MathJax-Element-47-Frame" class="mjx-chtml MathJax_CHTML" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mn>2</mn><mo>&amp;#x22C5;</mo><mtext>const</mtext><mo>&amp;#x2212;</mo><mfrac><mtext>sleep time</mtext><mfrac><mtext>run time</mtext><mtext>const</mtext></mfrac></mfrac></math>" role="presentation" style="font-size: 119%; text-align: center; position: relative;"><span id="MJXc-Node-510" class="mjx-math" aria-hidden="true"><span id="MJXc-Node-511" class="mjx-mrow"><span id="MJXc-Node-512" class="mjx-mn"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.37em; padding-bottom: 0.318em;">2</span></span><span id="MJXc-Node-513" class="mjx-mo MJXc-space2"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.003em; padding-bottom: 0.318em;">⋅</span></span><span id="MJXc-Node-514" class="mjx-mtext MJXc-space2"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.318em; padding-bottom: 0.37em;">const</span></span><span id="MJXc-Node-515" class="mjx-mo MJXc-space2"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.318em; padding-bottom: 0.423em;">−</span></span><span id="MJXc-Node-516" class="mjx-mfrac MJXc-space2"><span class="mjx-box MJXc-stacked" style="width: 4.51em; padding: 0px 0.12em;"><span class="mjx-numerator" style="width: 4.51em; top: -1.412em;"><span id="MJXc-Node-517" class="mjx-mtext"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.423em; padding-bottom: 0.528em;">sleep time</span></span></span><span class="mjx-denominator" style="width: 4.51em; bottom: -1.291em;"><span id="MJXc-Node-518" class="mjx-mfrac"><span class="mjx-box MJXc-stacked" style="width: 2.756em; padding: 0px 0.12em;"><span class="mjx-numerator" style="font-size: 70.7%; width: 3.898em; top: -1.312em;"><span id="MJXc-Node-519" class="mjx-mtext" style=""><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.37em; padding-bottom: 0.37em;">run time</span></span></span><span class="mjx-denominator" style="font-size: 70.7%; width: 3.898em; bottom: -0.551em;"><span id="MJXc-Node-520" class="mjx-mtext" style=""><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.318em; padding-bottom: 0.37em;">const</span></span></span><span class="mjx-line" style="border-bottom: 1.3px solid; top: -0.283em; width: 2.756em;"></span></span><span class="mjx-vsize" style="height: 1.317em; vertical-align: -0.389em;"></span></span></span><span class="mjx-line" style="border-bottom: 1.3px solid; top: -0.283em; width: 4.51em;"></span></span><span class="mjx-vsize" style="height: 2.703em; vertical-align: -1.291em;"></span></span></span></span><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mn>2</mn><mo>⋅</mo><mtext>const</mtext><mo>−</mo><mfrac><mtext>sleep time</mtext><mfrac><mtext>run time</mtext><mtext>const</mtext></mfrac></mfrac></math></span></span></span><script type="math/tex; mode=display" id="MathJax-Element-47"> 2 \cdot \text{const} - \frac{\text{sleep time}}{\frac{\text{run time}}{\text{const}}} </script></span></p><p><a href="http://bxr.su/FreeBSD/sys/kern/sched_ule.c#sched_interact_update" target="_blank" rel="noopener"><em><span>sched_interact_update</span></em></a></p><pre><code class="C hljs"><div class="wrapper"><div class="gutter linenumber"><span data-linenumber="1623"></span>
<span data-linenumber="1624"></span>
<span data-linenumber="1625"></span>
<span data-linenumber="1626"></span>
<span data-linenumber="1627"></span>
<span data-linenumber="1628"></span>
<span data-linenumber="1629"></span>
<span data-linenumber="1630"></span>
<span data-linenumber="1631"></span>
<span data-linenumber="1632"></span>
<span data-linenumber="1633"></span>
<span data-linenumber="1634"></span>
<span data-linenumber="1635"></span>
<span data-linenumber="1636"></span>
<span data-linenumber="1637"></span>
<span data-linenumber="1638"></span>
<span data-linenumber="1639"></span>
<span data-linenumber="1640"></span>
<span data-linenumber="1641"></span>
<span data-linenumber="1642"></span>
<span data-linenumber="1643"></span>
<span data-linenumber="1644"></span>
<span data-linenumber="1645"></span>
<span data-linenumber="1646"></span>
<span data-linenumber="1647"></span>
<span data-linenumber="1648"></span>
<span data-linenumber="1649"></span>
<span data-linenumber="1650"></span>
<span data-linenumber="1651"></span>
<span data-linenumber="1652"></span></div><div class="code"><span class="hljs-keyword">static</span> void
sched_interact_update(struct thread *td)
{
    struct td_sched *ts;
    u_int sum;

    ts = td_get_sched(td);
    sum = ts-&gt;ts_runtime + ts-&gt;ts_slptime;
    <span class="hljs-keyword">if</span> (sum &lt; SCHED_SLP_RUN_MAX)
        <span class="hljs-keyword">return</span>;
        
    <span class="hljs-keyword">if</span> (sum &gt; SCHED_SLP_RUN_MAX * <span class="hljs-number">2</span>) {
        <span class="hljs-keyword">if</span> (ts-&gt;ts_runtime &gt; ts-&gt;ts_slptime) {
            ts-&gt;ts_runtime = SCHED_SLP_RUN_MAX;
            ts-&gt;ts_slptime = <span class="hljs-number">1</span>;
        } <span class="hljs-keyword">else</span> {
            ts-&gt;ts_slptime = SCHED_SLP_RUN_MAX;
            ts-&gt;ts_runtime = <span class="hljs-number">1</span>;
        }
        <span class="hljs-keyword">return</span>;
    }
    
    <span class="hljs-keyword">if</span> (sum &gt; (SCHED_SLP_RUN_MAX / <span class="hljs-number">5</span>) * <span class="hljs-number">6</span>) {
        ts-&gt;ts_runtime /= <span class="hljs-number">2</span>;
        ts-&gt;ts_slptime /= <span class="hljs-number">2</span>;
        <span class="hljs-keyword">return</span>;
    }
    ts-&gt;ts_runtime = (ts-&gt;ts_runtime / <span class="hljs-number">5</span>) * <span class="hljs-number">4</span>;
    ts-&gt;ts_slptime = (ts-&gt;ts_slptime / <span class="hljs-number">5</span>) * <span class="hljs-number">4</span>;
}
</div></div></code></pre><ul>
<li><span>ustawiamy sumę czasów snu i działania</span></li>
<li><span>jeśli suma jest mniejsza niż stała to przerywamy</span></li>
<li><span>teraz mamy trzy przypadki:</span>
<ul>
<li><span>suma jest strasznie duża</span>
<ul>
<li><span>sprawdzamy, który z czasów jest większy (run / sleep)</span></li>
<li><span>ten większy ustawiamy na MAX</span></li>
<li><span>drugi na 1</span></li>
</ul>
</li>
<li><span>suma jest większa niż </span><span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span id="MathJax-Element-48-Frame" class="mjx-chtml MathJax_CHTML" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mfrac><mn>6</mn><mn>5</mn></mfrac><mo>&amp;#x22C5;</mo><mi>m</mi><mi>a</mi><mi>x</mi></math>" role="presentation" style="font-size: 119%; position: relative;"><span id="MJXc-Node-521" class="mjx-math" aria-hidden="true"><span id="MJXc-Node-522" class="mjx-mrow"><span id="MJXc-Node-523" class="mjx-mfrac"><span class="mjx-box MJXc-stacked" style="width: 0.495em; padding: 0px 0.12em;"><span class="mjx-numerator" style="font-size: 70.7%; width: 0.7em; top: -1.32em;"><span id="MJXc-Node-524" class="mjx-mn" style=""><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.37em; padding-bottom: 0.37em;">6</span></span></span><span class="mjx-denominator" style="font-size: 70.7%; width: 0.7em; bottom: -0.613em;"><span id="MJXc-Node-525" class="mjx-mn" style=""><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.37em; padding-bottom: 0.37em;">5</span></span></span><span class="mjx-line" style="border-bottom: 1.3px solid; top: -0.283em; width: 0.495em;"></span></span><span class="mjx-vsize" style="height: 1.366em; vertical-align: -0.433em;"></span></span><span id="MJXc-Node-526" class="mjx-mo MJXc-space2"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.003em; padding-bottom: 0.318em;">⋅</span></span><span id="MJXc-Node-527" class="mjx-mi MJXc-space2"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.213em; padding-bottom: 0.265em;">m</span></span><span id="MJXc-Node-528" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.213em; padding-bottom: 0.265em;">a</span></span><span id="MJXc-Node-529" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.213em; padding-bottom: 0.265em;">x</span></span></span></span><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mfrac><mn>6</mn><mn>5</mn></mfrac><mo>⋅</mo><mi>m</mi><mi>a</mi><mi>x</mi></math></span></span><script type="math/tex" id="MathJax-Element-48">\frac{6}{5} \cdot max</script></span>
<ul>
<li><span>dzielimy czas na 2</span></li>
</ul>
</li>
<li><span>w innym wypadku przemnażamy czas przez </span><span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span id="MathJax-Element-49-Frame" class="mjx-chtml MathJax_CHTML" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mfrac><mn>4</mn><mn>5</mn></mfrac></math>" role="presentation" style="font-size: 119%; position: relative;"><span id="MJXc-Node-530" class="mjx-math" aria-hidden="true"><span id="MJXc-Node-531" class="mjx-mrow"><span id="MJXc-Node-532" class="mjx-mfrac"><span class="mjx-box MJXc-stacked" style="width: 0.495em; padding: 0px 0.12em;"><span class="mjx-numerator" style="font-size: 70.7%; width: 0.7em; top: -1.309em;"><span id="MJXc-Node-533" class="mjx-mn" style=""><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.37em; padding-bottom: 0.318em;">4</span></span></span><span class="mjx-denominator" style="font-size: 70.7%; width: 0.7em; bottom: -0.613em;"><span id="MJXc-Node-534" class="mjx-mn" style=""><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.37em; padding-bottom: 0.37em;">5</span></span></span><span class="mjx-line" style="border-bottom: 1.3px solid; top: -0.283em; width: 0.495em;"></span></span><span class="mjx-vsize" style="height: 1.359em; vertical-align: -0.433em;"></span></span></span></span><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mfrac><mn>4</mn><mn>5</mn></mfrac></math></span></span><script type="math/tex" id="MathJax-Element-49">\frac{4}{5}</script></span></li>
</ul>
</li>
</ul><p><span>Efektem tych obliczeń jest wrzucenie nas w przedział do </span><code>SCHED_SLP_RUN_MAX</code><span>.</span></p><h2 id="Zadanie-5" data-id="Zadanie-5"><a class="anchor hidden-xs" href="#Zadanie-5" title="Zadanie-5"><span class="octicon octicon-link"></span></a><span>Zadanie 5.</span></h2><p><span>Liczymy wskaźnik: </span><code>imax(0, sched_interact_score(td) + td-&gt;td_proc-&gt;p_nice);</code><span> </span><code>td-&gt;td_proc-&gt;p_nice</code><span> oznacza piorytet nadany przez użytkownika.</span><br>
<span>Jeśli ten wskaźnik jest mniejszy od </span><code>sched_interact</code><span> (domyślnie 30) to przekształcamy go liniowo w przedział piorytetów [PRI_MIN_INTERACT, PRI_MAX_INTERACT], czyli [120, 160].</span><br>
<span>W przeciwnym przypadku w zależności od piorytetu użytkownika i czegość tam mapujemy piorytet w przedział [PRI_MIN_BATCH, PRI_MAX_BATCH] = [161, 223]:</span></p><pre><code class="c hljs"><div class="wrapper"><div class="gutter linenumber"><span data-linenumber="1"></span>
<span data-linenumber="2"></span>
<span data-linenumber="3"></span>
<span data-linenumber="4"></span></div><div class="code">    pri <span class="token operator">=</span> SCHED_PRI_MIN<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">td_get_sched</span><span class="token punctuation">(</span>td<span class="token punctuation">)</span><span class="token operator">-&gt;</span>ts_ticks<span class="token punctuation">)</span>
        pri <span class="token operator">+</span><span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span><span class="token function">SCHED_PRI_TICKS</span><span class="token punctuation">(</span><span class="token function">td_get_sched</span><span class="token punctuation">(</span>td<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> SCHED_PRI_RANGE <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pri <span class="token operator">+</span><span class="token operator">=</span> <span class="token function">SCHED_PRI_NICE</span><span class="token punctuation">(</span>td<span class="token operator">-&gt;</span>td_proc<span class="token operator">-&gt;</span>p_nice<span class="token punctuation">)</span><span class="token punctuation">;</span>
</div></div></code></pre><p><span>W zależności od piorytetu dodajemy na różne </span><code>runq</code><span>:</span></p><pre><code class="c hljs"><div class="wrapper"><div class="gutter linenumber"><span data-linenumber="1"></span>
<span data-linenumber="2"></span>
<span data-linenumber="3"></span>
<span data-linenumber="4"></span>
<span data-linenumber="5"></span>
<span data-linenumber="6"></span></div><div class="code">	<span class="token keyword">if</span> <span class="token punctuation">(</span>pri <span class="token operator">&lt;</span> PRI_MIN_BATCH<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		ts<span class="token operator">-&gt;</span>ts_runq <span class="token operator">=</span> <span class="token operator">&amp;</span>tdq<span class="token operator">-&gt;</span>tdq_realtime<span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pri <span class="token operator">&lt;=</span> PRI_MAX_BATCH<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		ts<span class="token operator">-&gt;</span>ts_runq <span class="token operator">=</span> <span class="token operator">&amp;</span>tdq<span class="token operator">-&gt;</span>tdq_timeshare<span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span>
		ts<span class="token operator">-&gt;</span>ts_runq <span class="token operator">=</span> <span class="token operator">&amp;</span>tdq<span class="token operator">-&gt;</span>tdq_idle<span class="token punctuation">;</span>
</div></div></code></pre><p><code>runq_add_pri</code><span> różni się tym, że ręczenie możemy sprecyzować z jakim piorytetem zostaniemy dodani na kolejkę </span><code>runq</code><span>. Tylko właśnie nie potrafię zrozumieć dlaczego chcielibyśmy to robić.</span></p><ul>
<li><span>Interrupt threads:       0 - 47</span></li>
<li><span>Realtime user threads:   48 - 79</span></li>
<li><span>Top half kernel threads: 80 - 119</span></li>
<li><span>Time sharing user threads:   120 - 223</span></li>
<li><span>Idle user threads:       224 - 255</span></li>
</ul><h2 id="Zadanie-6" data-id="Zadanie-6"><a class="anchor hidden-xs" href="#Zadanie-6" title="Zadanie-6"><span class="octicon octicon-link"></span></a><span>Zadanie 6.</span></h2><p><a href="http://bxr.su/FreeBSD/sys/kern/sched_ule.c#sched_pickcpu" target="_blank" rel="noopener"><span>sched_pickcpu()</span></a><br>
<span>Kolejne kryteria według którego wybieramy CPU na którym chcemy uruchomić wątek:</span></p><ol>
<li><span>Wątki mocno związane z konkretnym CPU nie chcemy przerzucać na inne cpu:</span></li>
</ol><pre><code class="c hljs"><div class="wrapper"><div class="gutter linenumber"><span data-linenumber="1"></span>
<span data-linenumber="2"></span></div><div class="code">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> SRQ_OURSELF<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">THREAD_CAN_MIGRATE</span><span class="token punctuation">(</span>td<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>ts<span class="token operator">-&gt;</span>ts_cpu<span class="token punctuation">)</span><span class="token punctuation">;</span>
</div></div></code></pre><ol start="2">
<li><span>Wątki pochodzące od przerwań lepiej jest schedulować na procesorze do którego przyszło to przerwane jeśli piorytet pozwala na natychmiastowe wykonanie. Może być to umotywowane tym, że chcemy szybko obsłużyć procedurę obsługi przerwania i raczej ona długo nie zajmie.</span></li>
</ol><pre><code class="c hljs"><div class="wrapper"><div class="gutter linenumber"><span data-linenumber="1"></span>
<span data-linenumber="2"></span>
<span data-linenumber="3"></span>
<span data-linenumber="4"></span>
<span data-linenumber="5"></span>
<span data-linenumber="6"></span>
<span data-linenumber="7"></span>
<span data-linenumber="8"></span>
<span data-linenumber="9"></span>
<span data-linenumber="10"></span>
<span data-linenumber="11"></span>
<span data-linenumber="12"></span>
<span data-linenumber="13"></span>
<span data-linenumber="14"></span>
<span data-linenumber="15"></span>
<span data-linenumber="16"></span></div><div class="code">	<span class="token keyword">if</span> <span class="token punctuation">(</span>td<span class="token operator">-&gt;</span>td_priority <span class="token operator">&lt;=</span> PRI_MAX_ITHD <span class="token operator">&amp;&amp;</span> <span class="token function">THREAD_CAN_SCHED</span><span class="token punctuation">(</span>td<span class="token punctuation">,</span> self<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
	    curthread<span class="token operator">-&gt;</span>td_intr_nesting_level<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		tdq <span class="token operator">=</span> <span class="token function">TDQ_SELF</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>tdq<span class="token operator">-&gt;</span>tdq_lowpri <span class="token operator">&gt;=</span> PRI_MIN_IDLE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">SCHED_STAT_INC</span><span class="token punctuation">(</span>pickcpu_idle_affinity<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		ts<span class="token operator">-&gt;</span>ts_cpu <span class="token operator">=</span> self<span class="token punctuation">;</span>
		intr <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
		cg <span class="token operator">=</span> tdq<span class="token operator">-&gt;</span>tdq_cg<span class="token punctuation">;</span>
		<span class="token keyword">goto</span> llc<span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		intr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		tdq <span class="token operator">=</span> <span class="token function">TDQ_CPU</span><span class="token punctuation">(</span>ts<span class="token operator">-&gt;</span>ts_cpu<span class="token punctuation">)</span><span class="token punctuation">;</span>
		cg <span class="token operator">=</span> tdq<span class="token operator">-&gt;</span>tdq_cg<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</div></div></code></pre><ol start="3">
<li><span>Jeśli cpu na którym ostatnio działał wątek jest idle to go wykorzystujemy. Opłaca się to z tego powodu, że pamięc cache może być wciąż aktualna</span></li>
</ol><pre><code class="C hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SCHED_AFFINITY(ts, t)   ((ts)-&gt;ts_rltick &gt; ticks - ((t) * affinity))</span>
</code></pre><pre><code class="c hljs"><div class="wrapper"><div class="gutter linenumber"><span data-linenumber="1"></span>
<span data-linenumber="2"></span>
<span data-linenumber="3"></span>
<span data-linenumber="4"></span>
<span data-linenumber="5"></span>
<span data-linenumber="6"></span>
<span data-linenumber="7"></span>
<span data-linenumber="8"></span>
<span data-linenumber="9"></span>
<span data-linenumber="10"></span>
<span data-linenumber="11"></span>
<span data-linenumber="12"></span>
<span data-linenumber="13"></span>
<span data-linenumber="14"></span>
<span data-linenumber="15"></span>
<span data-linenumber="16"></span>
<span data-linenumber="17"></span>
<span data-linenumber="18"></span>
<span data-linenumber="19"></span>
<span data-linenumber="20"></span>
<span data-linenumber="21"></span>
<span data-linenumber="22"></span>
<span data-linenumber="23"></span></div><div class="code">    <span class="token comment">/*
     * If the thread can run on the last cpu and the affinity has not
     * expired and it is idle, run it there.
     */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">THREAD_CAN_SCHED</span><span class="token punctuation">(</span>td<span class="token punctuation">,</span> ts<span class="token operator">-&gt;</span>ts_cpu<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
	    tdq<span class="token operator">-&gt;</span>tdq_lowpri <span class="token operator">&gt;=</span> PRI_MIN_IDLE <span class="token operator">&amp;&amp;</span>
	    <span class="token function">SCHED_AFFINITY</span><span class="token punctuation">(</span>ts<span class="token punctuation">,</span> CG_SHARE_L2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>cg<span class="token operator">-&gt;</span>cg_flags <span class="token operator">&amp;</span> CG_FLAG_THREAD<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">/* Check all SMT threads for being idle. */</span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span>cpu <span class="token operator">=</span> <span class="token function">CPU_FFS</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cg<span class="token operator">-&gt;</span>cg_mask<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> cpu<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">CPU_ISSET</span><span class="token punctuation">(</span>cpu<span class="token punctuation">,</span> <span class="token operator">&amp;</span>cg<span class="token operator">-&gt;</span>cg_mask<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
				    <span class="token function">TDQ_CPU</span><span class="token punctuation">(</span>cpu<span class="token punctuation">)</span><span class="token operator">-&gt;</span>tdq_lowpri <span class="token operator">&lt;</span> PRI_MIN_IDLE<span class="token punctuation">)</span>
					<span class="token keyword">break</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>cpu <span class="token operator">&gt;=</span> mp_maxid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token function">SCHED_STAT_INC</span><span class="token punctuation">(</span>pickcpu_idle_affinity<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">return</span> <span class="token punctuation">(</span>ts<span class="token operator">-&gt;</span>ts_cpu<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token function">SCHED_STAT_INC</span><span class="token punctuation">(</span>pickcpu_idle_affinity<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token punctuation">(</span>ts<span class="token operator">-&gt;</span>ts_cpu<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
</div></div></code></pre><ol start="4">
<li><span>Patrzymy na inne procesory w kolejności wyznaczonej spokrewnieniem z procesorem, na którym ostatnio wątek działał i jeśli jakiś jest idle to go bierzemy:</span></li>
</ol><pre><code class="c hljs"><div class="wrapper"><div class="gutter linenumber"><span data-linenumber="1"></span>
<span data-linenumber="2"></span>
<span data-linenumber="3"></span>
<span data-linenumber="4"></span>
<span data-linenumber="5"></span>
<span data-linenumber="6"></span>
<span data-linenumber="7"></span>
<span data-linenumber="8"></span>
<span data-linenumber="9"></span>
<span data-linenumber="10"></span>
<span data-linenumber="11"></span>
<span data-linenumber="12"></span>
<span data-linenumber="13"></span>
<span data-linenumber="14"></span>
<span data-linenumber="15"></span>
<span data-linenumber="16"></span>
<span data-linenumber="17"></span>
<span data-linenumber="18"></span>
<span data-linenumber="19"></span>
<span data-linenumber="20"></span>
<span data-linenumber="21"></span>
<span data-linenumber="22"></span>
<span data-linenumber="23"></span>
<span data-linenumber="24"></span>
<span data-linenumber="25"></span>
<span data-linenumber="26"></span>
<span data-linenumber="27"></span>
<span data-linenumber="28"></span>
<span data-linenumber="29"></span>
<span data-linenumber="30"></span>
<span data-linenumber="31"></span>
<span data-linenumber="32"></span>
<span data-linenumber="33"></span></div><div class="code"><span class="token keyword">for</span> <span class="token punctuation">(</span>ccg <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> cg <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> cg <span class="token operator">=</span> cg<span class="token operator">-&gt;</span>cg_parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>cg<span class="token operator">-&gt;</span>cg_flags <span class="token operator">&amp;</span> CG_FLAG_THREAD<span class="token punctuation">)</span>
			<span class="token keyword">continue</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>cg<span class="token operator">-&gt;</span>cg_children <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">||</span> cg<span class="token operator">-&gt;</span>cg_count <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
			<span class="token keyword">continue</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>cg<span class="token operator">-&gt;</span>cg_level <span class="token operator">==</span> CG_SHARE_NONE <span class="token operator">||</span>
		    <span class="token punctuation">(</span><span class="token operator">!</span>intr <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">SCHED_AFFINITY</span><span class="token punctuation">(</span>ts<span class="token punctuation">,</span> cg<span class="token operator">-&gt;</span>cg_level<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token keyword">continue</span><span class="token punctuation">;</span>
		ccg <span class="token operator">=</span> cg<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">/* Found LLC shared by all CPUs, so do a global search. */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ccg <span class="token operator">==</span> cpu_top<span class="token punctuation">)</span>
		ccg <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	cpu <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	mask <span class="token operator">=</span> td<span class="token operator">-&gt;</span>td_cpuset<span class="token operator">-&gt;</span>cs_mask<span class="token punctuation">;</span>
	pri <span class="token operator">=</span> td<span class="token operator">-&gt;</span>td_priority<span class="token punctuation">;</span>
	<span class="token comment">/*
	 * Try hard to keep interrupts within found LLC.  Search the LLC for
	 * the least loaded CPU we can run now.  For NUMA systems it should
	 * be within target domain, and it also reduces scheduling overhead.
	 */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ccg <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> intr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		cpu <span class="token operator">=</span> <span class="token function">sched_lowest</span><span class="token punctuation">(</span>ccg<span class="token punctuation">,</span> mask<span class="token punctuation">,</span> pri<span class="token punctuation">,</span> INT_MAX<span class="token punctuation">,</span> ts<span class="token operator">-&gt;</span>ts_cpu<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>cpu <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
			<span class="token function">SCHED_STAT_INC</span><span class="token punctuation">(</span>pickcpu_intrbind<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span>
	<span class="token comment">/* Search the LLC for the least loaded idle CPU we can run now. */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ccg <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		cpu <span class="token operator">=</span> <span class="token function">sched_lowest</span><span class="token punctuation">(</span>ccg<span class="token punctuation">,</span> mask<span class="token punctuation">,</span> <span class="token function">max</span><span class="token punctuation">(</span>pri<span class="token punctuation">,</span> PRI_MAX_TIMESHARE<span class="token punctuation">)</span><span class="token punctuation">,</span>
		    INT_MAX<span class="token punctuation">,</span> ts<span class="token operator">-&gt;</span>ts_cpu<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>cpu <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
			<span class="token function">SCHED_STAT_INC</span><span class="token punctuation">(</span>pickcpu_affinity<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</div></div></code></pre><ol start="5">
<li><span>Patrzymy na wszystkie CPU i bierzemy taki, który jest IDLE i ma najmniejsze obciążenie:</span></li>
</ol><pre><code class="c hljs"><div class="wrapper"><div class="gutter linenumber"><span data-linenumber="1"></span>
<span data-linenumber="2"></span>
<span data-linenumber="3"></span>
<span data-linenumber="4"></span>
<span data-linenumber="5"></span>
<span data-linenumber="6"></span></div><div class="code">	<span class="token comment">/* Search globally for the least loaded CPU we can run now. */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>cpu <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		cpu <span class="token operator">=</span> <span class="token function">sched_lowest</span><span class="token punctuation">(</span>cpu_top<span class="token punctuation">,</span> mask<span class="token punctuation">,</span> pri<span class="token punctuation">,</span> INT_MAX<span class="token punctuation">,</span> ts<span class="token operator">-&gt;</span>ts_cpu<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>cpu <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
			<span class="token function">SCHED_STAT_INC</span><span class="token punctuation">(</span>pickcpu_lowest<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</div></div></code></pre><ol start="6">
<li><span>Patrzymy na wszystkie CPU i bierzemy taki, który ma namniejsze obciążenie:</span></li>
</ol><pre><code class="c hljs"><div class="wrapper"><div class="gutter linenumber"><span data-linenumber="1"></span>
<span data-linenumber="2"></span>
<span data-linenumber="3"></span>
<span data-linenumber="4"></span>
<span data-linenumber="5"></span></div><div class="code">	<span class="token keyword">if</span> <span class="token punctuation">(</span>cpu <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		cpu <span class="token operator">=</span> <span class="token function">sched_lowest</span><span class="token punctuation">(</span>cpu_top<span class="token punctuation">,</span> mask<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> INT_MAX<span class="token punctuation">,</span> ts<span class="token operator">-&gt;</span>ts_cpu<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>cpu <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
			<span class="token function">SCHED_STAT_INC</span><span class="token punctuation">(</span>pickcpu_lowest<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</div></div></code></pre><ol start="7">
<li><span>Jeśli znalezione cpu nie jest obecnym procesorem to porównujemy go z nami (tzn. z procesorem, który wykonuje ten kod):</span></li>
</ol><pre><code class="c hljs"><div class="wrapper"><div class="gutter linenumber"><span data-linenumber="1"></span>
<span data-linenumber="2"></span>
<span data-linenumber="3"></span>
<span data-linenumber="4"></span>
<span data-linenumber="5"></span>
<span data-linenumber="6"></span>
<span data-linenumber="7"></span></div><div class="code">tdq <span class="token operator">=</span> <span class="token function">TDQ_CPU</span><span class="token punctuation">(</span>cpu<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">THREAD_CAN_SCHED</span><span class="token punctuation">(</span>td<span class="token punctuation">,</span> self<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">TDQ_SELF</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span>tdq_lowpri <span class="token operator">&gt;</span> pri <span class="token operator">&amp;&amp;</span>
	    tdq<span class="token operator">-&gt;</span>tdq_lowpri <span class="token operator">&lt;</span> PRI_MIN_IDLE <span class="token operator">&amp;&amp;</span>
	    <span class="token function">TDQ_SELF</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span>tdq_load <span class="token operator">&lt;=</span> tdq<span class="token operator">-&gt;</span>tdq_load <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">SCHED_STAT_INC</span><span class="token punctuation">(</span>pickcpu_local<span class="token punctuation">)</span><span class="token punctuation">;</span>
		cpu <span class="token operator">=</span> self<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</div></div></code></pre><p><span>Koszt migracji uwzględnia topologię architektury tj. procesory, rdzenie, wątki, pamięć podręczna, pamięć operacyjna.</span></p><h2 id="Zadanie-7" data-id="Zadanie-7"><a class="anchor hidden-xs" href="#Zadanie-7" title="Zadanie-7"><span class="octicon octicon-link"></span></a><span>Zadanie 7.</span></h2><p><span>Gdy wątek zamienia swój stan na gotowy lub gdy pewne CPU nie ma nic do robienia to wtedy ma miejsce proste równoważenie obciążenia. W dłuższym czasie jest to niewystarczające. Istnieje potrzeba przeanalizowania obciążenia każdego z CPU i ewentualne przeniesienie zadań na inne CPU biorąc pod uwagę hierarchię procesorów, tzn. ile współdzielą cache, czy mają wspólne jednostki obliczeniowe itp. To jest zadanie długoplanowego algorytmu równoważenia obciążenia.</span></p><p><span>Procedura </span><code>sched_balace()</code><span> jest uruchamiana co:</span></p><pre><code class="c hljs"><div class="wrapper"><div class="gutter linenumber"><span data-linenumber="1"></span>
<span data-linenumber="2"></span></div><div class="code">    balance_ticks <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span>balance_interval <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span>
        <span class="token punctuation">(</span><span class="token function">sched_random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> balance_interval<span class="token punctuation">)</span><span class="token punctuation">;</span>
</div></div></code></pre><p><span>średnio wychodzi, że co sekundę. Czas ten jest pewnym stopniu losowy, żeby zapobiec sytuacjom, w których okresy wybudzania wątków pokrywają się z okresem działania algorytmu równoważenia obciążenia.</span></p><p><code>sched_balance_pair</code><span>:</span></p><pre><code class="c hljs"><div class="wrapper"><div class="gutter linenumber"><span data-linenumber="1"></span>
<span data-linenumber="2"></span>
<span data-linenumber="3"></span>
<span data-linenumber="4"></span>
<span data-linenumber="5"></span>
<span data-linenumber="6"></span>
<span data-linenumber="7"></span>
<span data-linenumber="8"></span>
<span data-linenumber="9"></span>
<span data-linenumber="10"></span>
<span data-linenumber="11"></span>
<span data-linenumber="12"></span>
<span data-linenumber="13"></span>
<span data-linenumber="14"></span>
<span data-linenumber="15"></span>
<span data-linenumber="16"></span>
<span data-linenumber="17"></span></div><div class="code"><span class="token keyword">static</span> <span class="token keyword">int</span>
<span class="token function">sched_balance_pair</span><span class="token punctuation">(</span><span class="token keyword">struct</span> tdq <span class="token operator">*</span>high<span class="token punctuation">,</span> <span class="token keyword">struct</span> tdq <span class="token operator">*</span>low<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">struct</span> thread <span class="token operator">*</span>td<span class="token punctuation">;</span>
	<span class="token keyword">int</span> cpu<span class="token punctuation">;</span>

	<span class="token function">tdq_lock_pair</span><span class="token punctuation">(</span>high<span class="token punctuation">,</span> low<span class="token punctuation">)</span><span class="token punctuation">;</span>
	td <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>high<span class="token operator">-&gt;</span>tdq_transferable <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> high<span class="token operator">-&gt;</span>tdq_load <span class="token operator">&gt;</span> low<span class="token operator">-&gt;</span>tdq_load <span class="token operator">&amp;&amp;</span>
	    <span class="token punctuation">(</span>td <span class="token operator">=</span> <span class="token function">tdq_move</span><span class="token punctuation">(</span>high<span class="token punctuation">,</span> low<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		cpu <span class="token operator">=</span> <span class="token function">TDQ_ID</span><span class="token punctuation">(</span>low<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>cpu <span class="token operator">!=</span> <span class="token function">PCPU_GET</span><span class="token punctuation">(</span>cpuid<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token function">tdq_notify</span><span class="token punctuation">(</span>low<span class="token punctuation">,</span> td<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">tdq_unlock_pair</span><span class="token punctuation">(</span>high<span class="token punctuation">,</span> low<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token punctuation">(</span>td <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</div></div></code></pre><p><span>Co tutaj się dzieje?</span><br>
<span>7. Blokujemy struktury </span><code>struct tdq</code><span> ale w specjalny sposób. Żeby zapobiec zakleszczeniom jest użyty prosty trik - zakładamy blokady w kolejności od struktur od najmniejszych adresów. I to tym się zajmuje </span><code>tdq_lock_pair</code><span>:</span></p><pre><code class="c hljs"><div class="wrapper"><div class="gutter linenumber"><span data-linenumber="1"></span>
<span data-linenumber="2"></span>
<span data-linenumber="3"></span>
<span data-linenumber="4"></span>
<span data-linenumber="5"></span>
<span data-linenumber="6"></span>
<span data-linenumber="7"></span>
<span data-linenumber="8"></span>
<span data-linenumber="9"></span>
<span data-linenumber="10"></span>
<span data-linenumber="11"></span></div><div class="code"><span class="token keyword">static</span> <span class="token keyword">void</span>
<span class="token function">tdq_lock_pair</span><span class="token punctuation">(</span><span class="token keyword">struct</span> tdq <span class="token operator">*</span>one<span class="token punctuation">,</span> <span class="token keyword">struct</span> tdq <span class="token operator">*</span>two<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>one <span class="token operator">&lt;</span> two<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">TDQ_LOCK</span><span class="token punctuation">(</span>one<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">TDQ_LOCK_FLAGS</span><span class="token punctuation">(</span>two<span class="token punctuation">,</span> MTX_DUPOK<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
	<span class="token function">TDQ_LOCK</span><span class="token punctuation">(</span>two<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">TDQ_LOCK_FLAGS</span><span class="token punctuation">(</span>one<span class="token punctuation">,</span> MTX_DUPOK<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</div></div></code></pre><ol start="9">
<li><span>Jeśli cpu </span><code>high</code><span> ma jakiś wątek, który może odstąpić oraz jest bardziej obciążony to próbujemy zabrać odebrać jakiś wątek procedurą </span><code>tdq_move</code><span>.</span></li>
</ol><pre><code class="c hljs"><div class="wrapper"><div class="gutter linenumber"><span data-linenumber="1"></span>
<span data-linenumber="2"></span>
<span data-linenumber="3"></span>
<span data-linenumber="4"></span>
<span data-linenumber="5"></span>
<span data-linenumber="6"></span>
<span data-linenumber="7"></span>
<span data-linenumber="8"></span>
<span data-linenumber="9"></span>
<span data-linenumber="10"></span>
<span data-linenumber="11"></span>
<span data-linenumber="12"></span>
<span data-linenumber="13"></span>
<span data-linenumber="14"></span>
<span data-linenumber="15"></span>
<span data-linenumber="16"></span>
<span data-linenumber="17"></span>
<span data-linenumber="18"></span>
<span data-linenumber="19"></span>
<span data-linenumber="20"></span>
<span data-linenumber="21"></span>
<span data-linenumber="22"></span></div><div class="code"><span class="token keyword">static</span> <span class="token keyword">struct</span> thread <span class="token operator">*</span>
<span class="token function">tdq_move</span><span class="token punctuation">(</span><span class="token keyword">struct</span> tdq <span class="token operator">*</span>from<span class="token punctuation">,</span> <span class="token keyword">struct</span> tdq <span class="token operator">*</span>to<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">struct</span> thread <span class="token operator">*</span>td<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> tdq <span class="token operator">*</span>tdq<span class="token punctuation">;</span>
	<span class="token keyword">int</span> cpu<span class="token punctuation">;</span>

	tdq <span class="token operator">=</span> from<span class="token punctuation">;</span>
	cpu <span class="token operator">=</span> <span class="token function">TDQ_ID</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span><span class="token punctuation">;</span>
	td <span class="token operator">=</span> <span class="token function">tdq_steal</span><span class="token punctuation">(</span>tdq<span class="token punctuation">,</span> cpu<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>td <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">thread_lock_block_wait</span><span class="token punctuation">(</span>td<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sched_rem</span><span class="token punctuation">(</span>td<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">THREAD_LOCKPTR_ASSERT</span><span class="token punctuation">(</span>td<span class="token punctuation">,</span> <span class="token function">TDQ_LOCKPTR</span><span class="token punctuation">(</span>from<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	td<span class="token operator">-&gt;</span>td_lock <span class="token operator">=</span> <span class="token function">TDQ_LOCKPTR</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">td_get_sched</span><span class="token punctuation">(</span>td<span class="token punctuation">)</span><span class="token operator">-&gt;</span>ts_cpu <span class="token operator">=</span> cpu<span class="token punctuation">;</span>
	<span class="token function">tdq_add</span><span class="token punctuation">(</span>to<span class="token punctuation">,</span> td<span class="token punctuation">,</span> SRQ_YIELDING<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token punctuation">(</span>td<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</div></div></code></pre><p><span>tutaj próbujemy zabrać pewien wątek (jeden) z kolejek cpu </span><code>from</code><span>, a następnie przepinamy blokadę na tę z nowego cpu.</span><br>
<span>12-13. Jeśli obecnie nie wykonujemy się na cpu </span><code>low</code><span> to musimy poinformować tamten procesor o nowym wątku. Robimy to przez </span><code>tdq_notify</code><span> przy użyciu </span><code>IPI</code><span>.</span></p></div>
    <div class="ui-toc dropup unselectable hidden-print" style="display:none;">
        <div class="pull-right dropdown">
            <a id="tocLabel" class="ui-toc-label btn btn-default" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false" title="Table of content">
                <i class="fa fa-bars"></i>
            </a>
            <ul id="ui-toc" class="ui-toc-dropdown dropdown-menu" aria-labelledby="tocLabel">
                <div class="toc"><ul class="nav">
<li class=""><a href="#SJU-20200520" title="SJU 2020/05/20">SJU 2020/05/20</a><ul class="nav">
<li><a href="#Zadanie-1" title="Zadanie 1.">Zadanie 1.</a></li>
<li><a href="#Zadanie-2" title="Zadanie 2.">Zadanie 2.</a></li>
<li><a href="#Zadanie-3" title="Zadanie 3.">Zadanie 3.</a></li>
<li><a href="#Zadanie-4" title="Zadanie 4.">Zadanie 4.</a></li>
<li><a href="#Zadanie-5" title="Zadanie 5.">Zadanie 5.</a></li>
<li><a href="#Zadanie-6" title="Zadanie 6.">Zadanie 6.</a></li>
<li><a href="#Zadanie-7" title="Zadanie 7.">Zadanie 7.</a></li>
</ul>
</li>
</ul>
</div><div class="toc-menu"><a class="expand-toggle" href="#">Expand all</a><a class="back-to-top" href="#">Back to top</a><a class="go-to-bottom" href="#">Go to bottom</a></div>
            </ul>
        </div>
    </div>
    <div id="ui-toc-affix" class="ui-affix-toc ui-toc-dropdown unselectable hidden-print" data-spy="affix" style="top:17px;display:none;" null null>
        <div class="toc"><ul class="nav">
<li class=""><a href="#SJU-20200520" title="SJU 2020/05/20">SJU 2020/05/20</a><ul class="nav">
<li><a href="#Zadanie-1" title="Zadanie 1.">Zadanie 1.</a></li>
<li><a href="#Zadanie-2" title="Zadanie 2.">Zadanie 2.</a></li>
<li><a href="#Zadanie-3" title="Zadanie 3.">Zadanie 3.</a></li>
<li><a href="#Zadanie-4" title="Zadanie 4.">Zadanie 4.</a></li>
<li><a href="#Zadanie-5" title="Zadanie 5.">Zadanie 5.</a></li>
<li><a href="#Zadanie-6" title="Zadanie 6.">Zadanie 6.</a></li>
<li><a href="#Zadanie-7" title="Zadanie 7.">Zadanie 7.</a></li>
</ul>
</li>
</ul>
</div><div class="toc-menu"><a class="expand-toggle" href="#">Expand all</a><a class="back-to-top" href="#">Back to top</a><a class="go-to-bottom" href="#">Go to bottom</a></div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gist-embed/2.6.0/gist-embed.min.js" integrity="sha256-KyF2D6xPIJUW5sUDSs93vWyZm+1RzIpKCexxElmxl8g=" crossorigin="anonymous" defer></script>
    <script>
        var markdown = $(".markdown-body");
        //smooth all hash trigger scrolling
        function smoothHashScroll() {
            var hashElements = $("a[href^='#']").toArray();
            for (var i = 0; i < hashElements.length; i++) {
                var element = hashElements[i];
                var $element = $(element);
                var hash = element.hash;
                if (hash) {
                    $element.on('click', function (e) {
                        // store hash
                        var hash = this.hash;
                        if ($(hash).length <= 0) return;
                        // prevent default anchor click behavior
                        e.preventDefault();
                        // animate
                        $('body, html').stop(true, true).animate({
                            scrollTop: $(hash).offset().top
                        }, 100, "linear", function () {
                            // when done, add hash to url
                            // (default click behaviour)
                            window.location.hash = hash;
                        });
                    });
                }
            }
        }

        smoothHashScroll();
        var toc = $('.ui-toc');
        var tocAffix = $('.ui-affix-toc');
        var tocDropdown = $('.ui-toc-dropdown');
        //toc
        tocDropdown.click(function (e) {
            e.stopPropagation();
        });

        var enoughForAffixToc = true;

        function generateScrollspy() {
            $(document.body).scrollspy({
                target: ''
            });
            $(document.body).scrollspy('refresh');
            if (enoughForAffixToc) {
                toc.hide();
                tocAffix.show();
            } else {
                tocAffix.hide();
                toc.show();
            }
            $(document.body).scroll();
        }

        function windowResize() {
            //toc right
            var paddingRight = parseFloat(markdown.css('padding-right'));
            var right = ($(window).width() - (markdown.offset().left + markdown.outerWidth() - paddingRight));
            toc.css('right', right + 'px');
            //affix toc left
            var newbool;
            var rightMargin = (markdown.parent().outerWidth() - markdown.outerWidth()) / 2;
            //for ipad or wider device
            if (rightMargin >= 133) {
                newbool = true;
                var affixLeftMargin = (tocAffix.outerWidth() - tocAffix.width()) / 2;
                var left = markdown.offset().left + markdown.outerWidth() - affixLeftMargin;
                tocAffix.css('left', left + 'px');
            } else {
                newbool = false;
            }
            if (newbool != enoughForAffixToc) {
                enoughForAffixToc = newbool;
                generateScrollspy();
            }
        }
        $(window).resize(function () {
            windowResize();
        });
        $(document).ready(function () {
            windowResize();
            generateScrollspy();
        });

        //remove hash
        function removeHash() {
            window.location.hash = '';
        }

        var backtotop = $('.back-to-top');
        var gotobottom = $('.go-to-bottom');

        backtotop.click(function (e) {
            e.preventDefault();
            e.stopPropagation();
            if (scrollToTop)
                scrollToTop();
            removeHash();
        });
        gotobottom.click(function (e) {
            e.preventDefault();
            e.stopPropagation();
            if (scrollToBottom)
                scrollToBottom();
            removeHash();
        });

        var toggle = $('.expand-toggle');
        var tocExpand = false;

        checkExpandToggle();
        toggle.click(function (e) {
            e.preventDefault();
            e.stopPropagation();
            tocExpand = !tocExpand;
            checkExpandToggle();
        })

        function checkExpandToggle () {
            var toc = $('.ui-toc-dropdown .toc');
            var toggle = $('.expand-toggle');
            if (!tocExpand) {
                toc.removeClass('expand');
                toggle.text('Expand all');
            } else {
                toc.addClass('expand');
                toggle.text('Collapse all');
            }
        }

        function scrollToTop() {
            $('body, html').stop(true, true).animate({
                scrollTop: 0
            }, 100, "linear");
        }

        function scrollToBottom() {
            $('body, html').stop(true, true).animate({
                scrollTop: $(document.body)[0].scrollHeight
            }, 100, "linear");
        }
    </script>
</body>

</html>
